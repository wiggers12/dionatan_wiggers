<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>WiggersDev - Plataforma PRO</title>

    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons (√çcones) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs (v8 Puro e Est√°vel) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Estilos base para a aplica√ß√£o mobile-first */
        body {
            margin: 0;
            background: #0a0a0a;
            color: #fff;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Garantir que o jogo ocupe o m√°ximo de altura dispon√≠vel */
        iframe {
            width: 100%;
            border: none;
            /* Ajustado para compensar o cabe√ßalho (~48px) e o rodap√© flutuante (~72px) */
            height: calc(100vh - 120px);
        }

        /* Scroll invis√≠vel */
        *::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        /* Garantir que o JS dos √≠cones seja executado */
        [data-lucide] {
            display: inline-block;
        }
        /* Estilo para simular o estado de indispon√≠vel do √≠cone IA */
        .access-locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        /* Estilos do rel√≥gio (mantido) */
        #relogioFloating {
            position: fixed;
            top: 60px;
            left: 15px;
            background: rgba(0,0,0,0.65);
            padding: 8px 14px;
            border-radius: 8px;
            color: #00e676;
            font-size: 16px;
            font-weight: 700;
            border: 2px solid #00e676;
            box-shadow: 0 0 10px rgba(0,230,118,0.6);
            z-index: 9999;
            backdrop-filter: blur(6px);
        }
    </style>
</head>

<body>
    <div id="relogioFloating">00:00:00</div>
    <div id="app">
        <!-- O conte√∫do da aplica√ß√£o √© injetado aqui -->
        <div class="w-full min-h-screen flex items-center justify-center bg-[#1a1a1a] text-white">
            Aguardando verifica√ß√£o de acesso e carregamento de dados...
        </div>
    </div>

    <script>
        // --- Configura√ß√£o e Mapeamento de Dados ---
        const firebaseConfig = {
            apiKey: "AIzaSyBod8YVf5pKWI98m9rRR8axokDkNMlXX-k", 
            authDomain: "aviatordaniel100x.firebaseapp.com",
            projectId: "aviatordaniel100x",
            storageBucket: "aviatordaniel100x.firebasestorage.app",
            messagingSenderId: "169015417803",
            appId: "1:169015417803:web:ce4aa4f9b77d5ddb07344e"
        };
        
        // Vari√°veis de Estado (Simulam o estado do React)
        let db = null;
        let auth = null;
        let currentUserPhone = null; 
        let hasIaAccess = false;    
        
        let history = [];
        let nextSignal = null;
        let iaPrediction = null;
        let geminiSuggestion = null; 
        let greens = 0;
        let reds = 0;
        let total = 0;
        let predicting = true;
        
        // --- NOVO: Dados do Usu√°rio Logado ---
        let userProfileData = { nome: 'Convidado', status: 'TESTE', telefone: '' };
        
        // UI State (Controle de Modais)
        let openHistory = false;
        let openSignal = false;
        let openRules = false;
        let openLive = false;
        let openGemini = false; 
        let openAccessLock = false; 
        let openProfile = false; 

        const gameUrl = "https://rn72q.com/subscribeReward?pid=575973404"; 
        const WHATSAPP_LINK = "https://wa.me/5598987654321"; // Coloque o seu n√∫mero de WhatsApp aqui
        const TARGET_IA_PANEL_URL = "https://wiggers.dev.br/painelia.html";

        /* ============================================================
           FUN√á√ïES DE UTILIDADE
           ============================================================ */
        const getColorFromMultiplier = (v) => {
            const val = Number(v);
            if (val >= 10) return "text-pink-500";
            if (val >= 2) return "text-purple-400";
            if (val < 1.20) return "text-red-500";
            return "text-yellow-300";
        };

        const getPredictionColor = (prediction) => {
            if (!prediction || !prediction.signals || prediction.signals.length === 0) return 'text-gray-400';
            
            const signalValues = prediction.signals.map(v => parseFloat(v.valor));
            const hasRosa = signalValues.some(v => v >= 10.00);
            const hasRoxa = signalValues.some(v => v >= 2.00);

            if (hasRosa) return 'text-pink-500'; 
            if (hasRoxa) return 'text-purple-400'; 
            return 'text-gray-400';
        };
        
        // Fun√ß√£o para Logout
        const handleLogout = () => {
            auth.signOut().then(() => {
                // Redireciona para o login ap√≥s o logout
                window.location.href = "login_page.html";
            }).catch(error => {
                console.error("Erro ao fazer logout:", error);
                window.location.href = "login_page.html"; // For√ßa o redirecionamento mesmo com erro
            });
        };

        /* ============================================================
           MODAL FUNCTIONS (JS Puro) - In√≠cio
           ============================================================ */
        
        const toggleModal = (modalName) => {
            // Fun√ß√£o para fechar/abrir todos os modais
            openHistory = modalName === 'History' ? !openHistory : false;
            openSignal = modalName === 'Signal' ? !openSignal : false;
            openRules = modalName === 'Rules' ? !openRules : false;
            openLive = modalName === 'Live' ? !openLive : false;
            openGemini = modalName === 'Gemini' ? !openGemini : false; 
            openAccessLock = modalName === 'AccessLock' ? !openAccessLock : false;
            openProfile = modalName === 'Profile' ? !openProfile : false;
            
            renderApp();
        };

        // --- MODAL: Bloqueio de Acesso IA ---
        const renderAccessLockModal = () => {
            if (!openAccessLock) return '';
            
            return `
                <div class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
                    <div class="bg-red-900 w-full max-w-md p-6 rounded-xl shadow-xl border border-red-700">
                        <div class="flex justify-between items-center pb-3 border-b border-red-600">
                            <h2 class="text-xl font-bold flex items-center text-red-100">
                                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                                ACESSO RESTRITO AO PAINEL IA
                            </h2>
                            <button onclick="toggleModal('AccessLock')">
                                <i data-lucide="x" class="w-6 h-6 text-red-100"></i>
                            </button>
                        </div>
                        <div class="space-y-4 mt-4 text-red-200 text-sm">
                            <p>O Painel de Previs√µes IA Avan√ßado requer um UPGRADE de acesso.</p>
                            <p>Este recurso s√≥ √© liberado para o n√≠vel PAINEL IA.</p>
                            <a href="login_page.html" class="block mt-4 text-center text-sm font-bold bg-white text-red-900 py-2 rounded-lg hover:bg-gray-200 transition">
                                Retornar para Upgrade
                            </a>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- MODAIS COM BOT√ÉO VOLTAR ---
        const renderHistoryModal = () => { 
            if (!openHistory) return '';
            
            const historyList = history.map(item => `
                <div class="bg-[#263b2d] p-3 rounded-lg flex justify-between items-center">
                    <span class="text-sm text-gray-300">${item.time}</span>
                    <span class="text-lg font-bold ${item.color}">${item.multiplier}x</span>
                </div>
            `).join('');

            return `
                <div class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
                    <div class="bg-[#1E3224] w-full max-w-md p-5 rounded-xl shadow-xl max-h-[80vh] flex flex-col">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-3">
                            <h2 class="text-xl font-bold flex items-center">
                                <i data-lucide="clock" class="w-5 h-5 text-green-400 mr-2"></i>
                                Hist√≥rico de Multiplicadores
                            </h2>
                            <button onclick="toggleModal('History')" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow">
                                Voltar
                            </button>
                        </div>
                        <div class="overflow-y-auto mt-4 space-y-2 flex-1">
                            ${historyList}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderSignalModal = () => {
            if (!openSignal || !iaPrediction) return '';
            
            const signalValues = iaPrediction.signals ? iaPrediction.signals.map(Number) : [];
            const roxa = signalValues.filter(v => v >= 2 && v < 10).sort((a, b) => b - a)[0];
            const rosa = signalValues.filter(v => v >= 10).sort((a, b) => b - a)[0];

            return `
                <div class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
                    <div class="bg-[#1E3224] w-full max-w-md p-6 rounded-xl shadow-xl">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-3">
                            <h2 class="text-xl font-bold flex items-center">
                                <i data-lucide="trending-up" class="w-5 h-5 text-purple-400 mr-2"></i>
                                Pr√≥ximas Entradas IA
                            </h2>
                            <button onclick="toggleModal('Signal')" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow">
                                Voltar
                            </button>
                        </div>
                        <div class="space-y-4 mt-4">
                            ${(!roxa && !rosa) ? '<p class="text-center text-gray-400 text-sm">Nenhuma entrada ativa.</p>' : ''}
                            ${roxa ? `
                                <div class="bg-[#263b2d] p-4 rounded-lg border-l-4 border-purple-400 flex justify-between items-center">
                                    <span class="text-purple-400 font-bold">ENTRADA ROXA (2.0x - 9.99x)</span>
                                    <span class="text-3xl font-extrabold text-purple-400">${roxa.toFixed(2)}x</span>
                                </div>
                            ` : ''}
                            ${rosa ? `
                                <div class="bg-[#263b2d] p-4 rounded-lg border-l-4 border-pink-500 flex justify-between items-center">
                                    <span class="text-pink-500 font-bold">ENTRADA ROSA (10.0x - 50.0x)</span>
                                    <span class="text-3xl font-extrabold text-pink-500">${rosa.toFixed(2)}x</span>
                                </div>
                            ` : ''}
                        </div>
                        <p class="text-xs text-gray-500 mt-4 border-t border-gray-600 pt-2">
                            A IA monitora as pr√≥ximas 3 velas ap√≥s o sinal. Green confirmado se qualquer uma delas atingir o alvo.
                        </p>
                    </div>
                </div>
            `;
        };

        const renderRulesModal = () => { 
             if (!openRules) return '';

            return `
                <div class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
                    <div class="bg-[#1a1a1a] w-full max-w-md rounded-xl p-6 shadow-xl max-h-[85vh] overflow-hidden">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-3">
                            <h2 class="text-xl font-bold flex items-center">
                                <i data-lucide="zap" class="w-5 h-5 text-yellow-500 mr-2"></i>
                                Regras da Estrat√©gia
                            </h2>
                            <button onclick="toggleModal('Rules')" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow">
                                Voltar
                            </button>
                        </div>
                        <div class="space-y-4 mt-4 text-gray-300 text-sm">
                            <div class="bg-[#262626] p-3 rounded-lg"><p class="font-bold text-green-400 mb-1">üéØ Objetivo:</p>Buscar no m√≠nimo <strong>2.0x</strong> ap√≥s o sinal da IA.</div>
                            <div class="bg-[#262626] p-3 rounded-lg"><p class="font-bold text-yellow-400 mb-1">‚ö†Ô∏è Gest√£o de Risco:</p>M√°ximo 4 tentativas por sinal.</div>
                            <div class="bg-[#262626] p-3 rounded-lg"><p class="font-bold text-red-500 mb-1">üõë STOP:</p>Se 3 velas forem abaixo de 2.0x ‚Üí RED.</div>
                            <div class="bg-[#262626] p-3 rounded-lg border-t border-gray-600">
                                <p class="font-bold text-purple-400 mb-1">Dica de GALE (Propor√ß√£o):</p>
                                <p class="text-lg font-extrabold text-white tracking-widest">1 - 1 - 2 - 2</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderLiveModal = () => { 
             if (!openLive) return '';

            return `
                <div class="fixed inset-0 bg-black/70 z-50 flex justify-center items-end md:items-center p-0 md:p-4">
                    <div class="bg-[#1a1a1a] w-full max-w-lg h-[90vh] md:h-auto rounded-t-xl md:rounded-xl shadow-xl flex flex-col">
                        <div class="bg-red-700 p-4 text-white font-bold flex justify-between items-center rounded-t-xl">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-white rounded-full animate-ping mr-2"></div>
                                LIVE AO VIVO ‚Äî Sala PRO
                            </div>
                            <button onclick="toggleModal('Live')" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow">
                                Voltar
                            </button>
                        </div>
                        <div class="h-40 bg-black flex items-center justify-center text-gray-500 italic border-b border-gray-800">
                            Transmiss√£o do Analista...
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-2 text-sm">
                            <div style="color: green">Admin: Bem-vindos √† Live!</div>
                        </div>
                        <form class="p-3 border-t border-gray-700">
                            <input type="text" placeholder="Digite sua mensagem..." class="w-full p-2 rounded-lg bg-[#262626] text-white border border-green-500"/>
                        </form>
                    </div>
                </div>
            `;
        };
        
        const renderGeminiModal = () => { 
            if (!openGemini) return '';

            const suggestionText = geminiSuggestion && geminiSuggestion.sugestao ? geminiSuggestion.sugestao.replace(/\\n/g, '<br>') : 'Nenhuma sugest√£o de cen√°rio dispon√≠vel no momento.';

            return `
                <div class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
                    <div class="bg-[#1a1a1a] w-full max-w-md rounded-xl p-6 shadow-xl">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-3">
                            <h2 class="text-xl font-bold flex items-center">
                                <i data-lucide="message-square" class="w-5 h-5 text-indigo-400 mr-2"></i>
                                Sugest√µes da IA (Cen√°rios)
                            </h2>
                            <button onclick="toggleModal('Gemini')" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow">
                                Voltar
                            </button>
                        </div>
                        <div class="mt-4 text-gray-300 text-sm p-3 bg-[#262626] rounded-lg">
                            <p>${suggestionText}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">√öltima atualiza√ß√£o: ${geminiSuggestion && geminiSuggestion.updateTime ? geminiSuggestion.updateTime : 'N/A'}</p>
                    </div>
                </div>
            `;
        };
        
        const renderProfileModal = () => {
            if (!openProfile) return '';
            
            // Determina a cor do status
            let statusColor = userProfileData.status === 'VIP' ? 'text-green-500' : (userProfileData.status === 'TESTE' ? 'text-indigo-400' : 'text-gray-500');

            return `
                <div class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
                    <div class="bg-[#1E3224] w-full max-w-md p-6 rounded-xl shadow-xl border border-gray-700">
                        <div class="flex justify-between items-center pb-3 border-b border-gray-600">
                            <h2 class="text-xl font-bold flex items-center text-white">
                                <i data-lucide="user" class="w-5 h-5 mr-2 text-cyan-400"></i>
                                Minha Conta
                            </h2>
                            <button onclick="toggleModal('Profile')" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow">
                                Voltar
                            </button>
                        </div>

                        <div class="space-y-4 mt-4">
                            <div class="bg-[#263b2d] p-4 rounded-lg">
                                <p class="text-xs text-gray-400">NOME:</p>
                                <p class="text-lg font-semibold text-white">${userProfileData.nome}</p>
                            </div>
                            <div class="bg-[#263b2d] p-4 rounded-lg">
                                <p class="text-xs text-gray-400">TELEFONE:</p>
                                <p class="text-lg font-semibold text-white">${userProfileData.telefone}</p>
                            </div>
                            <div class="bg-[#263b2d] p-4 rounded-lg">
                                <p class="text-xs text-gray-400">STATUS:</p>
                                <p class="text-xl font-bold ${statusColor}">${userProfileData.status}</p>
                            </div>
                        </div>

                        <hr class="my-6 border-gray-700">
                        
                        <!-- BOT√ÉO DE LOGOUT -->
                        <button onclick="handleLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition shadow-md">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2 inline-block"></i> SAIR DA PLATAFORMA
                        </button>
                        
                        <!-- MENTORIA CTA -->
                        <a href="${WHATSAPP_LINK}" target="_blank" class="block mt-4 text-center text-sm font-bold text-green-400 hover:text-green-300">
                            <i data-lucide="phone" class="w-4 h-4 mr-1 inline-block"></i> Precisa de ajuda ou mentoria? Fale conosco!
                        </a>
                    </div>
                </div>
            `;
        };


        /* ============================================================
           FUN√á√ÉO DE RE-RENDERIZA√á√ÉO (Substitui o React)
           ============================================================ */
        const renderApp = () => {
            const appElement = document.getElementById('app');
            if (!appElement) return;

            const successRate = total > 0 ? ((greens / total) * 100).toFixed(2) : "0.00";
            const iaSignalColor = getPredictionColor(iaPrediction);
            const iaSignalValue = iaPrediction && iaPrediction.signals && iaPrediction.signals[0] ? parseFloat(iaPrediction.signals[0].valor) : null;
            
            const iaSignalText = iaSignalValue ? `${iaSignalValue.toFixed(2)}x` : 'AGUARDANDO...';
            const predictingClass = predicting || !iaSignalValue ? 'animate-pulse' : '';
            const loaderIcon = predicting || !iaSignalValue ? `<i data-lucide="loader" class="w-6 h-6 text-purple-400 animate-spin"></i>` : `<i data-lucide="trending-up" class="w-6 h-6" style="color: ${iaSignalColor.replace('text-', '')}"></i>`;

            // L√≥gica para o bot√£o de PREVIS√ïES IA (Bloqueio)
            const handlePredictingClick = hasIaAccess ? "toggleModal('Signal')" : "toggleModal('AccessLock')";
            const iaButtonClasses = hasIaAccess ? 'hover:bg-white/10' : 'access-locked';


            const mainContent = `
                <!-- NAVBAR (Topo) -->
                <div class="bg-[#111] text-white p-3 flex justify-between items-center shadow-xl z-10">
                    <div class="flex space-x-6 text-sm font-medium">
                        <span class="text-green-400 font-bold">üéÆ JOGO</span>
                        <span class="text-gray-400 hover:text-white cursor-pointer transition" onclick="toggleModal('History')">
                            üìú HIST√ìRICO
                        </span>
                        <span onclick="toggleModal('Profile')" class="text-gray-400 hover:text-white cursor-pointer transition flex items-center">
                            üë§ PERFIL
                        </span>
                    </div>

                    <!-- √öLTIMO SINAL -->
                    <div class="flex items-center bg-[#2a3b2f] p-2 rounded-full border border-green-500/40">
                        <i data-lucide="zap" class="w-4 h-4 text-green-400 mr-1"></i>
                        <span class="text-xs text-gray-400">√öltimo:</span>

                        <span class="ml-2 font-bold ${nextSignal ? getColorFromMultiplier(nextSignal.valor) : "text-gray-500"}">
                            ${nextSignal ? `${Number(nextSignal.valor).toFixed(2)}x` : "--"}
                        </span>
                    </div>
                </div>

                <!-- √ÅREA PRINCIPAL ‚Äî JOGO -->
                <div class="flex-1 overflow-hidden">
                    <iframe
                        src="${gameUrl}"
                        allow="fullscreen"
                        title="Jogo Integrado"
                    ></iframe>
                </div>

                <!-- RODAP√â FLUTUANTE -->
                <div class="fixed bottom-0 left-0 right-0 p-4 flex justify-center z-20">
                    <div class="flex w-full max-w-lg space-x-2">

                        <!-- SUGEST√ÉO IA (NOVO POSICIONAMENTO) -->
                        <button onclick="toggleModal('Gemini')" class="flex-1 bg-[#111]/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-3 flex flex-col items-center hover:bg-white/10 transition">
                            <i data-lucide="message-square" class="w-6 h-6 text-indigo-400"></i>
                            <span class="text-sm mt-1 font-bold">Sugest√£o IA</span>
                            <span class="text-[10px] text-gray-400">${geminiSuggestion ? 'ATIVO' : 'OFF'}</span>
                        </button>
                        
                        <!-- ASSERTIVIDADE -->
                        <div class="flex-1 bg-[#111]/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-3 flex flex-col items-center">
                            <i data-lucide="check-circle" class="w-6 h-6 text-cyan-400"></i>
                            <span class="text-sm mt-1 font-bold">${successRate}%</span>
                            <span class="text-[11px] text-gray-400">
                                ${greens}G ‚Ä¢ ${reds}R
                            </span>
                        </div>

                        <!-- PREVIS√ïES IA (Controle de Acesso) -->
                        <button onclick="${handlePredictingClick}" class="flex-1 bg-[#111]/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-3 flex flex-col items-center hover:bg-white/10 transition ${iaButtonClasses}">
                            ${loaderIcon}
                            <span class="text-sm font-bold mt-1 ${iaSignalColor} ${predictingClass}">
                                ${predicting ? 'AGUARDANDO...' : iaSignalText}
                            </span>
                            <span class="text-[10px] text-gray-400">Previs√£o IA</span>
                        </button>

                        <!-- REGRAS -->
                        <button onclick="toggleModal('Rules')" class="flex-1 bg-[#111]/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-3 flex flex-col items-center hover:bg-white/10 transition">
                            <i data-lucide="zap" class="w-6 h-6 text-yellow-500"></i>
                            <span class="text-sm mt-1 font-bold">Regras</span>
                            <span class="text-[10px] text-gray-400">Estrat√©gia</span>
                        </button>
                        
                        <!-- LIVE -->
                        <button onclick="toggleModal('Live')" class="flex-1 bg-[#111]/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-3 flex flex-col items-center hover:bg-white/10 transition">
                            <i data-lucide="heart" class="w-6 h-6 text-red-500" fill="red"></i>
                            <span class="text-sm mt-1 font-bold">Live</span>
                            <span class="text-[10px] text-gray-400">Analista</span>
                        </button>
                    </div>
                </div>

                <!-- MODAIS -->
                ${renderHistoryModal()}
                ${renderSignalModal()}
                ${renderRulesModal()}
                ${renderLiveModal()}
                ${renderGeminiModal()}
                ${renderAccessLockModal()}
                ${renderProfileModal()}
            `;
            appElement.innerHTML = mainContent;
            
            // Ativar Lucide Icons ap√≥s inje√ß√£o de HTML
            if(window.lucide) {
                window.lucide.createIcons();
            }
        };

        /* ============================================================
           FIREBASE INITIALIZATION & LISTENERS
           ============================================================ */
        const initFirebase = () => {
            try {
                // Inicializa√ß√£o da aplica√ß√£o
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(app);
                auth = firebase.auth(app); 
                
                // --- LEITURA DO TELEFONE DA URL ---
                const urlParams = new URLSearchParams(window.location.search);
                const phone = urlParams.get('userphone');
                
                if (!phone) {
                    // Se n√£o houver telefone na URL, redireciona para o login
                    window.location.href = "login_page.html";
                    return;
                }

                currentUserPhone = phone; // Define a chave do usu√°rio logado
                
                // --- OBT√âM DADOS DO JOGADOR NO FIRESTORE USANDO O TELEFONE ---
                db.collection('jogador').doc(phone).get().then(playerDoc => {
                    if (playerDoc.exists) {
                        const data = playerDoc.data();
                        const now = new Date().getTime();

                        // 1. Verifica se a conta est√° ativa e n√£o expirou
                        const isExpired = data.status === 'TESTE' && (data.data_inicio_teste.toDate().getTime() + 12 * 60 * 60 * 1000) < now;
                        
                        if (data.ativo === false || isExpired) {
                            // Se desativado ou expirado, for√ßa redirecionamento
                            auth.signOut();
                            window.location.href = "login_page.html";
                            return;
                        }
                        
                        hasIaAccess = data.acesso_ia === true; // Define a flag de acesso IA
                        
                        // Atualiza o estado do perfil
                        userProfileData = { 
                            nome: data.nome || 'Convidado', 
                            status: data.status || 'N/A', 
                            telefone: data.telefone || 'N/A' 
                        };

                        // Ap√≥s a verifica√ß√£o de acesso, inicia os Listeners
                        startDataListeners();
                        
                    } else {
                        // Se o documento n√£o existe no Firestore, for√ßa redirecionamento
                        auth.signOut();
                        window.location.href = "login_page.html";
                    }
                }).catch(e => {
                    console.error("Erro ao verificar jogador no Firestore:", e);
                    window.location.href = "login_page.html"; // Falha de comunica√ß√£o = volta para login
                });
                
            } catch (e) {
                console.error("Erro Fatal na Inicializa√ß√£o do Firebase:", e);
                document.getElementById('app').innerHTML = `<div style="padding: 20px; color: red;">Erro ao carregar a plataforma. Verifique sua chave API e conex√£o de internet.</div>`;
            }
        };

        // --- Inicia Listeners SOMENTE ap√≥s o Login ser verificado ---
        const startDataListeners = () => {
             // 1. LISTENER: hist√≥rico_sinais
            db.collection("historico_sinais").limit(40).onSnapshot((snap) => {
                history = snap.docs.map((doc) => {
                    const d = doc.data();
                    let time = '';
                    try { time = d.criado && d.criado.toDate ? d.criado.toDate().toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }) : 'N/A'; } catch (e) { /* silent fail */ }
                    return { id: doc.id, multiplier: Number(d.valor).toFixed(2), color: getColorFromMultiplier(d.valor), time: time };
                });
                renderApp();
            });

            // 2. LISTENER: ultimo_sinal/dados
            db.collection("ultimo_sinal").doc("dados").onSnapshot((doc) => {
                if (!doc.exists) return;
                const d = doc.data();
                nextSignal = { valor: Number(d.valor), cor: d.cor, hora: d.hora };
                renderApp();
            });

            // 3. LISTENER: assertividade/dado
            db.collection("assertividade").doc("dado").onSnapshot((doc) => {
                if (!doc.exists) return;
                const d = doc.data();
                greens = d.greens || 0;
                reds = d.reds || 0;
                total = d.total || 0;
                renderApp();
            });

            // 4. LISTENER: analises/sequencia_3_azuis/sinais
            db.collection("analises").doc("sequencia_3_azuis").collection("sinais").onSnapshot((snap) => {
                if (snap.empty) {
                    iaPrediction = null;
                    predicting = true;
                    renderApp();
                    return;
                }

                const sortedDocs = snap.docs.sort((a, b) => b.id.localeCompare(a.id));
                const d = sortedDocs[0].data();

                if (d.status !== "ATIVO" || !d.valores || d.valores.length < 2) {
                    iaPrediction = null;
                    predicting = true;
                } else {
                    iaPrediction = {
                        status: d.status,
                        signals: d.valores.map(v => ({ valor: Number(v).toFixed(2) }))
                    };
                    
                    setTimeout(() => {
                       predicting = false;
                       renderApp();
                    }, 500);
                }
                renderApp();
            });
            
            // 5. LISTENER: setup/dashboard_metrics/ultima_sugestao_ia
            db.collection("setup").doc("dashboard_metrics").onSnapshot((doc) => {
                if (!doc.exists) return;
                const d = doc.data();
                if (d.ultima_sugestao_ia) {
                    geminiSuggestion = {
                        sugestao: d.ultima_sugestao_ia,
                        updateTime: d.ultimo_update && d.ultimo_update.toDate ? d.ultimo_update.toDate().toLocaleTimeString("pt-BR", {hour: "2-digit", minute: "2-digit"}) : 'N/A'
                    };
                } else {
                     geminiSuggestion = null;
                }
                renderApp();
            });
        };

        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
        window.onload = function() {
            initFirebase();
            
            // Inicializar e rodar o rel√≥gio a cada segundo
            function atualizarRelogio() {
                const el = document.getElementById("relogioFloating");
                if (!el) return;

                const agora = new Date();
                const h = String(agora.getHours()).padStart(2, '0');
                const m = String(agora.getMinutes()).padStart(2, '0');
                const s = String(agora.getSeconds()).padStart(2, '0');

                el.textContent = `${h}:${m}:${s}`;
            }

            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
        };

    </script>
</body>
</html>
