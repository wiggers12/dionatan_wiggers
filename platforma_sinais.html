<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>WiggersDev - Plataforma PRO</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React / ReactDOM / Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase v9 compat (somente leitura) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            margin: 0;
            background: #111; /* Tom de cinza escuro para melhor contraste */
            color: #fff;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
            /* Melhoria de usabilidade para mobile/toque */
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        iframe {
            width: 100%;
            border: none;
            /* Ajustado para tela cheia menos o navbar e o footer */
            height: calc(100vh - 140px); 
        }

        /* Scroll invis√≠vel */
        *::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        /* Estilos para o indicador de Janela Quente */
        @keyframes pulse-hot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        .animate-pulse-hot {
            animation: pulse-hot 1.5s infinite;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
/* ============================================================
   FUN√á√ïES DE UTILIDADE
   ============================================================ */
const getColorFromMultiplier = (v) => {
    const val = Number(v);
    if (val >= 10) return "text-pink-500";
    if (val >= 2) return "text-purple-400";
    if (val < 1.20) return "text-red-500";
    return "text-yellow-300";
};

/* ============================================================
   MODAL ‚Äî ONBOARDING (TOUR VISUAL COM CARDS)
   ============================================================ */
const OnboardingImageModal = ({ open, onClose, onOptOut }) => {
    if (!open) return null;
    // For√ßa a renderiza√ß√£o dos √≠cones Lucide dentro do modal
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    return (
        <div className="fixed inset-0 bg-black/90 z-[100] flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-green-500/50">

                {/* TOPO */}
                <div className="flex justify-between items-center bg-[#111] px-6 py-4 border-b border-gray-700">
                    <h2 className="text-2xl font-extrabold flex items-center text-green-400">
                        <i data-lucide="sparkles" className="w-7 h-7 mr-3"></i>
                        Guia de Navega√ß√£o PRO!
                    </h2>
                    <button 
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Fechar
                    </button>
                </div>

                {/* CONTE√öDO SCROLLABLE */}
                <div className="overflow-y-auto p-6 space-y-6 text-gray-300">
                    
                    <p className="text-sm border-b border-gray-700 pb-3">
                        Seu app de an√°lise e gest√£o foi carregado. Para maximizar seus lucros, entenda a fun√ß√£o de cada ferramenta de IA e os seus gatilhos.
                    </p>

                    {/* SE√á√ÉO 1: ALERTAS DE A√á√ÉO IMEDIATA */}
                    <div className="bg-[#262626] p-4 rounded-xl border-l-4 border-red-500">
                        <h3 className="font-bold text-lg text-red-400 flex items-center mb-2">
                            <i data-lucide="bell" className="w-5 h-5 mr-2"></i>
                            Alertas R√°pidos (Topo Esquerdo)
                        </h3>
                        <p className="text-xs">
                            Estes sinais aparecem logo abaixo do cabe√ßalho e indicam a leitura de sequ√™ncias perigosas ou altamente lucrativas.
                        </p>
                        <ul className="list-disc list-inside space-y-1 ml-2 mt-2 text-xs font-semibold">
                             <li>{`**Sinais de 4 Rodadas (BUSCAR):** Ativados ap√≥s um gatilho de ciclo (ex: Roxa > 10x seguida de Azul < 1.50x). Permanecem vis√≠veis por 4 rodadas.`}</li>
                             <li>**Alertas R√°pidos:** Incluem **"Poss√≠vel 2x/3x"** e **"Explos√£o Detectada"** (ap√≥s 8 azuis seguidas).</li>
                        </ul>
                    </div>
                    
                    {/* SE√á√ÉO 2: FERRAMENTAS DO RODAP√â (FOOTER) */}
                    <div className="space-y-3">
                        <h3 className="font-bold text-lg text-cyan-400 flex items-center">
                            <i data-lucide="bar-chart-3" className="w-5 h-5 mr-2"></i>
                            Ferramentas de An√°lise (Rodap√©)
                        </h3>
                        
                        <div className="bg-[#262626] p-3 rounded-lg border-l-4 border-cyan-400">
                            <p className="font-bold text-sm">Assertividade (G/R)</p>
                            <p className="text-xs">Sua taxa de sucesso hist√≥rica. √â a prova social da efic√°cia do sistema.</p>
                        </div>
                        <div className="bg-[#262626] p-3 rounded-lg border-l-4 border-purple-400">
                            <p className="font-bold text-sm">Previs√£o IA (Sinais)</p>
                            <p className="text-xs">Sugest√£o de alvos (Roxo ou Rosa) para as pr√≥ximas rodadas. O sinal √© ativado pelo sistema de backend com base em padr√µes de velas.</p>
                        </div>
                        <div className="bg-[#262626] p-3 rounded-lg border-l-4 border-yellow-400">
                            <p className="font-bold text-sm">IA de Minutos (Estrat√©gia)</p>
                            <p className="text-xs">Calcula o **Score de Confian√ßa (0-3)** medindo o atraso dos picos (2x, 5x, 10x). O score 2 ou 3 indica "Janela Quente" (Hora de Entrar!).</p>
                        </div>
                        <div className="bg-[#262626] p-3 rounded-lg border-l-4 border-pink-500">
                            <p className="font-bold text-sm">Explos√£o IA (N√≠vel 1-3)</p>
                            <p className="text-xs">Analisa a densidade de drenagem para prever a intensidade do pr√≥ximo ciclo de alta (N√≠vel 3 = Alta Probabilidade de Rosa).</p>
                        </div>
                    </div>

                    {/* SE√á√ÉO 3: GEST√ÉO E SUPORTE */}
                    <div className="space-y-3">
                        <h3 className="font-bold text-lg text-pink-400 flex items-center">
                            <i data-lucide="shield-half" className="w-5 h-5 mr-2"></i>
                            Gest√£o de Risco e Suporte
                        </h3>
                        
                        <div className="bg-[#262626] p-3 rounded-lg border-l-4 border-yellow-400">
                            <p className="font-bold text-sm">Gerenciamento de Risco (Menu)</p>
                            <p className="text-xs">Use a calculadora para definir o **Valor Ideal de Stake** com base na sua Banca Total e no Risco M√°ximo (recomendado 1% a 2%).</p>
                        </div>
                    </div>

                </div>

                {/* FOOTER */}
                <div className="p-4 bg-[#111] border-t border-gray-700 flex justify-between items-center">
                    <span onClick={onOptOut} className="flex items-center space-x-2 cursor-pointer text-gray-500 hover:text-white transition text-xs">
                         <i data-lucide="eye-off" className="w-4 h-4"></i>
                         <span>N√£o mostrar este guia novamente.</span>
                    </span>
                    <button 
                        onClick={onClose}
                        className="bg-green-600 hover:bg-green-700 p-3 rounded-xl font-bold text-white text-lg shadow-lg transition"
                    >
                        ENTENDI, VAMOS FATURAR!
                    </button>
                </div>

            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî OFERTA LAST MINUTE (APARECE NO LOGOUT)
   ============================================================ */
const LastMinuteOfferModal = ({ open, onAccept, onReject, onOptOut }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const phoneNumber = "51989378751";
    const waLink = `https://wa.me/55${phoneNumber}?text=Ol%C3%A1%2C%20vi%20a%20oferta%20de%20%4049%2C99%20e%20quero%20operar%20agora%20ao%20vivo%21`;

    return (
        <div className="fixed inset-0 bg-black/95 z-[101] flex justify-center items-center p-4">
            <div className="bg-[#2a1a3a] w-full max-w-sm rounded-2xl shadow-2xl flex flex-col border-4 border-purple-500/80">

                {/* TOPO E T√çTULO */}
                <div className="px-6 py-4 bg-[#1a1a1a] border-b border-purple-700">
                    <h2 className="text-2xl font-extrabold text-center text-purple-400">
                        OPERA√á√ÉO AO VIVO!
                    </h2>
                    <p className="text-sm text-center text-gray-400 mt-1">Sua √∫ltima chance de faturar hoje.</p>
                </div>

                {/* CONTE√öDO */}
                <div className="p-6 text-white text-center">
                    <p className="text-lg font-bold mb-3">
                        Percebemos que voc√™ est√° saindo...
                    </p>
                    
                    <p className="text-4xl font-extrabold text-pink-500 mb-4">
                        <span className="text-xl line-through text-gray-500 mr-2">R$ 99,99</span> R$ 49,99!
                    </p>

                    <p className="text-sm mb-4 text-gray-300">
                        Opere **comigo ao vivo** por 1 hora ou at√© obtermos seus primeiros lucros. Estou dispon√≠vel **AGORA** para te guiar.
                    </p>

                    <a
                        href={waLink}
                        target="_blank"
                        rel="noopener noreferrer"
                        onClick={onAccept}
                        className="w-full mt-2 flex items-center justify-center p-3 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg transition shadow-lg space-x-2"
                    >
                        <i data-lucide="zap" className="w-5 h-5"></i>
                        <span>CLICA NO LINK E VAMO PRA CIMA!</span>
                    </a>
                    
                    <button
                        onClick={onReject}
                        className="w-full mt-3 p-2 rounded-lg text-gray-400 hover:text-white transition text-sm font-semibold"
                    >
                        N√£o, obrigado. Prefiro sair agora.
                    </button>
                </div>

                {/* OP√á√ÉO DE OPT-OUT */}
                <div className="p-3 bg-[#111] border-t border-gray-800 flex justify-end items-center text-xs">
                    <span onClick={onOptOut} className="flex items-center space-x-2 cursor-pointer text-red-400 hover:text-red-300 transition">
                         <i data-lucide="eye-off" className="w-4 h-4"></i>
                         <span>N√£o mostrar esta oferta novamente.</span>
                    </span>
                </div>

            </div>
        </div>
    );
};


/* ============================================================
   MODAL ‚Äî LIVE STREAM (Apenas para VIPs)
   ============================================================ */
const LiveStreamModal = ({ open, onClose, isVip }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    // VOC√ä DEVE COLAR O TOKEN JWT V√ÅLIDO (GERADO NO BACKEND) AQUI
    // IMPORTANTE: Este token tem uma validade de 1h
    const tokenDeAcesso = "COLE O SEU TOKEN JWT AQUI"; 

    // O URL para o seu VPaaS Jitsi Meet (deve ser o mesmo no ficheiro Admin)
    const jitsiBaseUrl = "https://8x8.vc/vpaas-magic-cookie-bea217d68a5746d6b367f99361c20750";
    const roomName = "live_do_milhao"; 

    const jitsiUrl = `${jitsiBaseUrl}/${roomName}?t=${tokenDeAcesso}&config.prejoinPageEnabled=false&interfaceConfig.TOOLBAR_BUTTONS=%5B%27camera%27%2C%20%27chat%27%2C%20%27fullscreen%2C%20%27tileview%27%5D`;

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-2xl rounded-xl shadow-xl flex flex-col max-h-[95vh] overflow-hidden">

                {/* TOPO */}
                <div className="flex justify-between items-center bg-red-700 px-4 py-3 text-white font-bold rounded-t-xl">
                    <h2 className="text-lg flex items-center">
                        <div className="w-3 h-3 bg-white rounded-full animate-ping mr-2"></div>
                        LIVE EXCLUSIVA VIP
                    </h2>
                    <button 
                        onClick={onClose}
                        className="bg-black/20 hover:bg-black/40 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Fechar
                    </button>
                </div>

                {/* CONTE√öDO DA LIVE */}
                <div className="flex-1 overflow-hidden p-3 md:p-4 bg-[#0a0a0a] flex justify-center items-center">
                    
                    {isVip ? (
                        tokenDeAcesso && tokenDeAcesso.length > 50 ? ( // Verifica se o token foi colado
                            <iframe
                                src={jitsiUrl}
                                allow="camera; microphone; display-capture"
                                title="Live Stream VIP"
                                className="w-full h-full min-h-[400px] rounded-lg border-2 border-green-500"
                            ></iframe>
                        ) : (
                            <div className="text-center p-6 bg-[#262626] rounded-xl text-yellow-500">
                                <i data-lucide="alert-triangle" className="w-8 h-8 mx-auto mb-3"></i>
                                <p className="font-bold">ERRO DE CONFIGURA√á√ÉO (APP)</p>
                                <p className="text-sm text-gray-400">O token JWT de acesso n√£o foi colado no c√≥digo do aplicativo.</p>
                            </div>
                        )
                    ) : (
                        /* TELA DE BLOQUEIO PARA N√ÉO-VIP */
                        <div className="text-center p-8 bg-red-800/20 rounded-xl border border-red-700 max-w-sm">
                            <i data-lucide="lock" className="w-10 h-10 text-red-500 mx-auto mb-4"></i>
                            <p className="text-xl font-bold text-red-400 mb-2">ACESSO BLOQUEADO</p>
                            <p className="text-gray-300 text-sm">Esta √© uma transmiss√£o exclusiva para membros VIP.</p>
                            <a 
                                href="#"
                                className="mt-4 inline-block bg-pink-600 hover:bg-pink-700 text-white font-bold p-3 rounded-lg transition shadow-lg"
                                onClick={() => { 
                                    onClose(); 
                                    document.getElementById('openMentoriaButton').click(); // Simula o clique no bot√£o de Mentoria
                                }}
                            >
                                <i data-lucide="star" className="w-5 h-5 mr-1 inline-block"></i>
                                Clique e Garanta seu Acesso VIP
                            </a>
                        </div>
                    )}
                </div>

            </div>
        </div>
    );
};


/* ============================================================
   MODAL ‚Äî MENU PRINCIPAL
   ============================================================ */
const MenuModal = ({ open, onClose, onHistory, onProfile, onRiskManagement, onAttemptLogout }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const MenuItem = ({ icon, label, color, onClick }) => (
        <button
            className={`flex items-center p-4 rounded-xl transition w-full text-left bg-[#1a1a1a] border-l-4 ${color} hover:bg-[#262626]`}
            onClick={() => { onClick(); onClose(); }}
        >
            <i data-lucide={icon} className={`w-5 h-5 ${color} mr-3`}></i>
            <span className="font-semibold text-white">{label}</span>
        </button>
    );

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#111] w-full max-w-sm rounded-xl p-6 shadow-2xl flex flex-col">

                {/* TOPO E T√çTULO */}
                <div className="flex justify-between items-center pb-4 border-b border-gray-700">
                    <h2 className="text-2xl font-extrabold flex items-center text-green-400">
                        <i data-lucide="menu" className="w-6 h-6 mr-3"></i>
                        Menu Principal PRO
                    </h2>
                    <button 
                        onClick={onClose}
                        className="text-white bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Fechar
                    </button>
                </div>

                {/* OP√á√ïES */}
                <div className="mt-6 space-y-4">
                    
                    <MenuItem 
                        icon="user-circle" 
                        label="Meu Perfil e Status" 
                        color="text-purple-400"
                        onClick={onProfile}
                    />
                    
                    <div className="border-t border-gray-800 pt-4 space-y-4">
                        <MenuItem 
                            icon="settings" 
                            label="Configura√ß√µes e Risco" 
                            color="text-yellow-400"
                            onClick={onRiskManagement}
                        />
                        <MenuItem 
                            icon="shield-alert" 
                            label="Stop Loss e Gain (Meta)" 
                            color="text-orange-400"
                            onClick={onRiskManagement}
                        />
                    </div>
                    
                    {/* Bot√£o SAIR agora chama o gatilho centralizado */}
                    <button
                        onClick={onAttemptLogout}
                        className="w-full mt-6 bg-red-700 hover:bg-red-600 transition p-3 rounded-xl font-bold text-white shadow-lg flex items-center justify-center space-x-2"
                    >
                        <i data-lucide="log-out" className="w-5 h-5"></i>
                        <span>SAIR (Limpar Sess√£o)</span>
                    </button>
                </div>

            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî MENTORIA
   ============================================================ */
const MentoriaModal = ({ open, onClose }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const [copied, setCopied] = React.useState(false);
    const phoneNumber = "51989378751";
    
    // Fun√ß√£o para copiar para a √°rea de transfer√™ncia
    const handleCopy = () => {
        // Usa document.execCommand('copy') como fallback seguro em iframes
        const el = document.createElement('textarea');
        el.value = phoneNumber;
        document.body.appendChild(el);
        el.select();
        try {
            document.execCommand('copy');
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
        } catch (err) {
            console.error('Falha ao copiar:', err);
        }
        document.body.removeChild(el);
    };

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-sm rounded-xl p-6 shadow-xl flex flex-col">

                {/* TOPO E T√çTULO */}
                <div className="flex justify-between items-center pb-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold flex items-center text-pink-500">
                        <i data-lucide="award" className="w-6 h-6 mr-2"></i>
                        Mentoria PRO
                    </h2>
                    <button 
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Voltar
                    </button>
                </div>

                {/* CARD DE CTA */}
                <div className="mt-4 p-5 rounded-xl bg-[#222] border-t-4 border-pink-500 shadow-lg">
                    <p className="text-lg font-extrabold text-white mb-2">
                        Perder dinheiro virou h√°bito?
                    </p>
                    <p className="text-gray-300 text-sm">
                        Aprenda a fazer o certo, venha fazer uma mentoria e aprenda a ganhar dinheiro de uma vez por todas.
                    </p>
                    
                    <p className="mt-4 font-bold text-lg text-green-400">
                        Me chama no WhatsApp e bora faturar:
                    </p>

                    <div className="flex justify-between items-center mt-3 bg-[#333] p-3 rounded-lg border border-green-500">
                        <span className="font-mono text-white text-base break-all">
                            {phoneNumber}
                        </span>
                        <button
                            onClick={handleCopy}
                            className={`ml-2 px-3 py-1 rounded-full text-xs font-bold transition ${copied ? 'bg-green-500' : 'bg-cyan-500 hover:bg-cyan-600'}`}
                        >
                            {copied ? 'COPIADO!' : 'COPIAR'}
                        </button>
                    </div>

                    <a
                        href={`https://wa.me/55${phoneNumber}?text=Ol%C3%A1%2C%20quero%20saber%20mais%20sobre%20a%20Mentoria%20PRO%20Aviator!`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="w-full mt-4 flex items-center justify-center p-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold transition shadow-lg"
                    >
                        <i data-lucide="message-square" className="w-5 h-5 mr-2"></i>
                        Chamar no Chat
                    </a>
                </div>

            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî GERENCIAMENTO DE RISCO
   ============================================================ */
const RiskManagementModal = ({ open, onClose }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const [banca, setBanca] = React.useState(1000);
    const [riscoPercent, setRiscoPercent] = React.useState(1); // 1%
    const [stakeValue, setStakeValue] = React.useState(10.00);

    React.useEffect(() => {
        const newStake = (banca * (riscoPercent / 100)).toFixed(2);
        setStakeValue(Number(newStake));
    }, [banca, riscoPercent]);

    const formatCurrency = (value) => `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-md rounded-xl p-6 shadow-xl flex flex-col">

                {/* TOPO E T√çTULO */}
                <div className="flex justify-between items-center pb-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold flex items-center text-yellow-400">
                        <i data-lucide="calculator" className="w-6 h-6 mr-2"></i>
                        C√°lculo de Risco e Stake
                    </h2>
                    <button 
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Voltar
                    </button>
                </div>

                {/* CALCULADORA DE RISCO */}
                <div className="mt-4 space-y-4">
                    
                    {/* INPUT - BANCA INICIAL */}
                    <div>
                        <label className="text-sm text-gray-300 flex justify-between">
                            Banca Inicial (Total)
                            <span className="font-bold text-white">{formatCurrency(banca)}</span>
                        </label>
                        <input
                            type="number"
                            min="10"
                            step="10"
                            value={banca}
                            onChange={(e) => setBanca(Number(e.target.value))}
                            className="w-full p-3 mt-1 bg-[#222] border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-yellow-400"
                            placeholder="Ex: 1000"
                        />
                    </div>

                    {/* INPUT - RISCO POR APOSTA */}
                    <div>
                        <label className="text-sm text-gray-300 flex justify-between">
                            Risco por Aposta (Comprometimento)
                            <span className="font-bold text-white">{riscoPercent}%</span>
                        </label>
                        <input
                            type="range"
                            min="0.5"
                            max="5"
                            step="0.5"
                            value={riscoPercent}
                            onChange={(e) => setRiscoPercent(Number(e.target.value))}
                            className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg"
                        />
                        <p className="text-xs text-gray-500 mt-1">Recomendado: 1% a 2%.</p>
                    </div>
                </div>

                {/* RESULTADO - VALOR IDEAL PARA APOSTAR */}
                <div className="mt-6 p-4 rounded-xl bg-green-700/30 border-l-4 border-green-400 shadow-md">
                    <p className="text-sm font-semibold text-green-400">Valor Ideal de Stake (Entrada √önica):</p>
                    <p className="text-3xl font-extrabold text-white mt-1">
                        {formatCurrency(stakeValue)}
                    </p>
                    <p className="text-xs text-green-300 mt-2">
                        Com uma banca de {formatCurrency(banca)}, o valor m√°ximo para comprometer em uma √∫nica entrada, com risco de {riscoPercent}%, √© de {formatCurrency(stakeValue)}.
                    </p>
                </div>

                <p className="text-xs text-gray-500 mt-4 border-t border-gray-700 pt-2">
                    A gest√£o de banca √© o pilar mais importante para a consist√™ncia. Nunca exceda seu limite de risco.
                </p>

            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî PERFIL 
   ============================================================ */
const ProfileModal = ({ open, onClose, userData, userConfig }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const statusClasses = userConfig?.vip ? "bg-green-500 text-green-900" : "bg-yellow-500 text-yellow-900";
    const statusText = userConfig?.vip ? "VIP Ativo" : "Acesso B√°sico";

    const displayId = userData?.telefone || "ID N√£o Registrado";
    const displayName = userData?.nome || "Usu√°rio An√¥nimo";

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-sm rounded-xl p-6 shadow-xl flex flex-col">

                {/* TOPO E T√çTULO */}
                <div className="flex justify-between items-center pb-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold flex items-center">
                        <i data-lucide="user-circle" className="w-6 h-6 text-cyan-400 mr-2"></i>
                        Meu Perfil
                    </h2>
                    <button 
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Voltar
                    </button>
                </div>

                {/* STATUS VIP */}
                <div className={`mt-4 p-3 rounded-lg text-center font-bold ${statusClasses}`}>
                    {statusText}
                </div>

                {/* DETALHES DO USU√ÅRIO */}
                <div className="mt-4 space-y-3">
                    <div className="bg-[#262626] p-3 rounded-lg">
                        <p className="text-sm text-gray-400">Nome:</p>
                        <p className="font-semibold text-white break-all">{displayName}</p>
                    </div>

                    <div className="bg-[#262626] p-3 rounded-lg">
                        <p className="text-sm text-gray-400">Telefone/ID:</p>
                        <p className="font-semibold text-white break-all">{displayId}</p>
                    </div>
                </div>

                {/* BOT√ÉO DE SAIR */}
                <button
                    onClick={onAttemptLogout} /* CHAMA O GATILHO DE LOGOUT/OFERTA */
                    className="w-full mt-6 bg-red-600 hover:bg-red-700 transition p-3 rounded-lg font-bold text-white shadow-lg flex items-center justify-center space-x-2"
                >
                    <i data-lucide="log-out" className="w-5 h-5"></i>
                    <span>Limpar Sess√£o e Sair</span>
                </button>

                <p className="text-xs text-gray-500 text-center mt-4">
                    Limpar a sess√£o ir√° for√ßar o uso de um novo ID no pr√≥ximo acesso.
                </p>

            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî TIPMINER (ANTIGO HIST√ìRICO)
   ============================================================ */
const HistoryModal = ({ open, onClose, history }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const getBgFromValue = (v) => {
        const val = Number(v);
        if (val >= 10) return "bg-pink-600";       // ROSA
        if (val >= 2) return "bg-purple-600";     // ROXA
        return "bg-blue-600";                     // AZUL
    };

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-lg rounded-xl shadow-xl flex flex-col max-h-[85vh] overflow-hidden">

                {/* TOPO */}
                <div className="flex justify-between items-center bg-[#111] px-4 py-3 border-b border-gray-800">
                    <h2 className="text-lg font-bold flex items-center">
                        <i data-lucide="clock" className="w-5 h-5 text-green-400 mr-2"></i>
                        TipMiner (Multiplicadores)
                    </h2>

                    <button 
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Voltar
                    </button>
                </div>

                {/* LISTA DE CARDS */}
                <div className="overflow-y-auto p-4 grid grid-cols-3 gap-3">

                    {history.map((item) => (
                        <div
                            key={item.id}
                            className={`rounded-lg p-3 text-center shadow-lg text-white font-bold ${getBgFromValue(item.mul)}`}
                        >
                            <span className="text-sm">{item.time}</span>
                            <div className="text-xl mt-1">{item.mul}x</div>
                        </div>
                    ))}
                </div>

            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî SINAIS IA
   ============================================================ */
const SignalModal = ({ open, onClose, prediction }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    let roxa = null;
    let rosa = null;

    if (prediction && prediction.signals.length > 0) {
        const sorted = [...prediction.signals].map(Number);

        roxa = sorted.filter(v => v >= 2 && v < 10).sort((a, b) => b - a)[0];
        rosa = sorted.filter(v => v >= 10).sort((a, b) => b - a)[0];
    }

    return (
        <div className="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-md rounded-xl p-6 shadow-xl max-h-[85vh] overflow-hidden">

                {/* TOPO + BOT√ÉO VOLTAR */}
                <div className="flex justify-between items-center pb-3 border-b border-gray-700">
                    <h2 className="text-xl font-bold flex items-center">
                        <i data-lucide="brain" className="w-5 h-5 text-purple-400 mr-2"></i>
                        Pr√≥ximas Entradas IA
                    </h2>

                    <button 
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Voltar
                    </button>
                </div>

                {/* CONTE√öDO */}
                <div className="space-y-4 mt-4">

                    {!roxa && !rosa && (
                        <p className="text-center text-gray-400 text-sm">
                            Nenhuma entrada ativa no momento.
                        </p>
                    )}

                    {roxa && (
                        <div className="bg-[#262626] p-4 rounded-lg border-l-4 border-purple-400 flex justify-between items-center">
                            <span className="text-purple-400 font-bold">ENTRADA ROXA</span>
                            <span className="text-3xl font-extrabold text-purple-400">
                                {roxa.toFixed(2)}x
                            </span>
                        </div>
                    )}

                    {rosa && (
                        <div className="bg-[#262626] p-4 rounded-lg border-l-4 border-pink-500 flex justify-between items-center">
                            <span className="text-pink-500 font-bold">ENTRADA ROSA</span>
                            <span className="text-3xl font-extrabold text-pink-500">
                                {rosa.toFixed(2)}x
                            </span>
                        </div>
                    )}

                </div>

                <p className="text-xs text-gray-500 mt-4 border-t border-gray-700 pt-2">
                    A IA monitora as pr√≥ximas 3 velas ap√≥s o sinal. Green confirmado se qualquer uma delas atingir o alvo.
                </p>
            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî IA MINUTOS (AGORA COM SCORE)
   ============================================================ */
const MinutosIAModal = ({ open, onClose, minutos2x, minutos5x, minutos10x, janelaQuenteScore, sugestaoMinutos }) => {
    if (!open) return null;
    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const getStatus = (min, minMin, minMax) => {
        if (min < minMin) {
            return { text: "Normal", color: "text-green-400", bg: "bg-green-700/20", border: "border-green-400" };
        }
        if (min >= minMin && min <= minMax) {
            return { text: "QUENTE üî•", color: "text-pink-500", bg: "bg-pink-700/20", border: "border-pink-500" };
        }
        if (min > minMax) {
            return { text: "Atraso Extremo", color: "text-red-400", bg: "bg-red-700/20", border: "border-red-400" };
        }
        return { text: "Normal", color: "text-green-400", bg: "bg-green-700/20", border: "border-green-400" };
    };

    const status2x = getStatus(minutos2x, 3, 5);
    const status5x = getStatus(minutos5x, 7, 10);
    const status10x = getStatus(minutos10x, 10, 15);

    let scoreText;
    if (janelaQuenteScore >= 3) {
        scoreText = "SINAL M√ÅXIMO (3/3)";
    } else if (janelaQuenteScore === 2) {
        scoreText = "SINAL FORTE (2/3)";
    } else if (janelaQuenteScore === 1) {
        scoreText = "SINAL MODERADO (1/3)";
    } else {
        scoreText = "JANELA FRIA (0/3)";
    }

    const scoreBg = janelaQuenteScore >= 2 ? 'bg-pink-600 text-white' : janelaQuenteScore === 1 ? 'bg-yellow-600 text-black' : 'bg-gray-700 text-gray-400';

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-md rounded-xl p-6 shadow-xl max-h-[85vh] overflow-hidden">

                {/* TOPO + BOT√ÉO VOLTAR */}
                <div className="flex justify-between items-center pb-3 border-b border-gray-700">
                    <h2 className="text-xl font-bold flex items-center">
                        <i data-lucide="clock" className="w-5 h-5 text-yellow-500 mr-2"></i>
                        IA de Minutos - Score de Confian√ßa
                    </h2>

                    <button
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Voltar
                    </button>
                </div>

                {/* SUGEST√ÉO R√ÅPIDA NO TOPO DO MODAL */}
                {sugestaoMinutos ? (
                    <div className="mt-4 p-3 rounded-lg text-center font-extrabold text-lg bg-green-700/50 text-green-400 border border-green-400">
                        {sugestaoMinutos} AGORA!
                    </div>
                ) : null}

                {/* SCORE DE CONFIAN√áA */}
                <div className={`mt-4 p-4 rounded-lg text-center font-extrabold text-lg ${scoreBg}`}>
                    {scoreText}
                </div>

                {/* CONTE√öDO - TEMPO DESDE O √öLTIMO X */}
                <div className="space-y-3 mt-4 text-gray-300 text-sm">

                    {/* CARD 2X */}
                    <div className={`p-3 rounded-lg border-l-4 ${status2x.border} flex justify-between items-center ${status2x.bg}`}>
                        <div className="flex flex-col">
                            <span className="font-bold text-purple-400">√öltimo 2.0x (Roxo):</span>
                            <span className={`text-xs font-semibold ${status2x.color}`}>{status2x.text}</span>
                        </div>
                        <span className="text-xl font-extrabold text-white">
                            {minutos2x} min
                        </span>
                    </div>

                    {/* CARD 5X */}
                    <div className={`p-3 rounded-lg border-l-4 ${status5x.border} flex justify-between items-center ${status5x.bg}`}>
                        <div className="flex flex-col">
                            <span className="font-bold text-yellow-400">√öltimo 5.0x:</span>
                            <span className={`text-xs font-semibold ${status5x.color}`}>{status5x.text}</span>
                        </div>
                        <span className="text-xl font-extrabold text-white">
                            {minutos5x} min
                        </span>
                    </div>

                    {/* CARD 10X */}
                    <div className={`p-3 rounded-lg border-l-4 ${status10x.border} flex justify-between items-center ${status10x.bg}`}>
                        <div className="flex flex-col">
                            <span className="font-bold text-pink-500">√öltimo 10.0x (Rosa):</span>
                            <span className={`text-xs font-semibold ${status10x.color}`}>{status10x.text}</span>
                        </div>
                        <span className="text-xl font-extrabold text-white">
                            {minutos10x} min
                        </span>
                    </div>

                </div>

                <p className="text-xs text-gray-500 mt-4 border-t border-gray-700 pt-2">
                    O Score de Confian√ßa indica quantos multiplicadores est√£o na "Janela Quente" (2x: 3-5min, 5x: 7-10min, 10x: 10-15min). Quanto maior o score, mais prov√°vel √© o ciclo de alta.
                </p>
            </div>
        </div>
    );
};

/* ============================================================
   MODAL ‚Äî IA DE 3 N√çVEIS DE EXPLOS√ÉO (PainelIA)
   ============================================================ */
const ExplosionPanelModal = ({ open, onClose, nivelAtual, proximaExplosao, min2xExp, min5xExp, min10xExp, densidadeBaixa, tendencia }) => {
    // CORRE√á√ÉO CR√çTICA: Depende apenas do estado 'open' para abrir.
    if (!open) return null; 

    React.useEffect(() => {
        if (typeof lucide !== 'undefined' && open) {
            lucide.createIcons();
        }
    }, [open]);

    const cores = {
        1: "bg-green-600 border-green-400",
        2: "bg-purple-600 border-purple-400",
        3: "bg-pink-600 border-pink-400"
    };
    
    // Fallback: Usa o estado, que j√° √© garantido ser um objeto em App
    const currentExplosion = proximaExplosao;
    
    // Trata o caso de dados incompletos ou "An√°lise Indispon√≠vel"
    if (!currentExplosion || !currentExplosion.tipo || currentExplosion.tipo === 'An√°lise Indispon√≠vel') {
        currentExplosion.tipo = "An√°lise Indispon√≠vel";
        currentExplosion.faixa = "--";
        currentExplosion.prob = "Baixa";
        currentExplosion.motivo = "Dados insuficientes ou falha na leitura.";
    }


    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
            <div className="bg-[#1a1a1a] w-full max-w-sm rounded-xl p-6 shadow-xl flex flex-col">

                {/* TOPO E T√çTULO */}
                <div className="flex justify-between items-center pb-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold flex items-center text-pink-500">
                        <i data-lucide="bomb" className="w-6 h-6 mr-2"></i>
                        IA - Ciclo de Explos√£o
                    </h2>
                    <button 
                        onClick={onClose}
                        className="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm font-semibold shadow"
                    >
                        Voltar
                    </button>
                </div>

                <h3 className="font-bold text-lg mt-4 mb-2 text-white">Classifica√ß√£o do N√≠vel</h3>

                <div className={`p-4 rounded-xl text-center font-extrabold text-2xl mb-4 text-white border-l-4 ${cores[nivelAtual]}`}>
                    N√çVEL {nivelAtual}: {currentExplosion.tipo.toUpperCase()}
                </div>

                <div className="space-y-2 text-sm">
                    <div className="bg-[#262626] p-3 rounded-lg">
                        <strong>Faixa de Alvo:</strong> <span className="float-right font-semibold">{currentExplosion.faixa}</span>
                    </div>
                    <div className="bg-[#262626] p-3 rounded-lg">
                        <strong>Probabilidade:</strong> <span className="float-right font-semibold text-yellow-400">{currentExplosion.prob}</span>
                    </div>
                    <div className="bg-[#262626] p-3 rounded-lg">
                        <strong>Motivo:</strong> <span className="float-right text-right">{currentExplosion.motivo}</span>
                    </div>
                </div>

                {/* DETALHES T√âCNICOS */}
                <p className="mt-4 text-xs text-gray-400 border-t border-gray-700 pt-3">
                    ** Indicadores Chave **
                    <br/>
                    ‚è≥ √öltimo 2x: <span className="font-semibold text-purple-400">{min2xExp} min</span> | 5x: <span className="font-semibold text-yellow-400">{min5xExp} min</span> | 10x: <span className="font-semibold text-pink-500">{min10xExp} min</span>
                    <br/>
                    üìâ Densidade Baixa (√∫ltimas 300): <span className="font-semibold">{densidadeBaixa}</span>
                    <br/>
                    üìà Tend√™ncia Atual (5 velas): <span className={`font-semibold ${tendencia === 'alta' ? 'text-green-400' : tendencia === 'queda' ? 'text-red-400' : 'text-gray-400'}`}>{tendencia.toUpperCase()}</span>
                </p>
            </div>
        </div>
    );
};


/* ============================================================
   NAVIGATION BAR (Topo) - REORGANIZADA E COMPACTA
   ============================================================ */
const NavigationBar = ({ onMenu, onHistory, onMentoria, currentTime, firstName }) => { 
    return (
        // Reduzido o padding para p-2 para ocupar menos espa√ßo
        <div className="bg-[#111] text-white p-2 flex justify-between items-center shadow-xl z-10 relative"> 
            
            {/* 1. GRUPO ESQUERDO (MENU + TIPMINER ICON + NOME) */}
            <div className="flex items-center space-x-2">
                <button
                    onClick={onMenu}
                    className="p-1.5 rounded-lg hover:bg-[#222] transition"
                >
                    <i data-lucide="menu" className="w-6 h-6 text-green-400"></i>
                </button>
                
                {/* TIPMINER ICON (Maior) */}
                <button
                    onClick={onHistory}
                    className="flex items-center p-1.5 text-sm font-medium text-cyan-400 hover:bg-[#222] transition rounded-lg"
                >
                    {/* Tamanho w-6 h-6 para ser um pouco maior, p-1.5 mantido */}
                    <i data-lucide="line-chart" className="w-6 h-6"></i>
                </button>

                {/* NOME DO USU√ÅRIO (NOVO LOCAL) */}
                <span className="text-sm font-bold text-yellow-300 truncate max-w-[100px] sm:max-w-none">
                    Ol√°, {firstName || 'JOGADOR'}
                </span>
            </div>


            {/* 3. GRUPO DIREITO (REL√ìGIO + MENTORIA) */}
            <div className="flex items-center space-x-3">
                {/* REL√ìGIO ATUAL */}
                <div className="flex items-center bg-[#1a1a1a] p-2 rounded-full border border-green-500/40 font-mono">
                    <i data-lucide="clock-4" className="w-4 h-4 text-green-400 mr-2"></i>
                    <span className="text-sm font-bold text-green-400">{currentTime}</span>
                </div>
                
                 {/* MENTORIA VIS√çVEL */}
                 <button
                    id="openMentoriaButton"
                    onClick={onMentoria}
                    className="p-2 rounded-lg hover:bg-[#222] transition"
                 >
                    <i data-lucide="award" className="w-6 h-6 text-pink-500"></i>
                </button>
            </div>
        </div>
    );
};

/* ============================================================
   FOOTER FLUTUANTE (AJUSTADO PARA SER MAIS COMPACTO)
   ============================================================ */
const FooterBar = ({
    greens,
    reds,
    total,
    prediction,
    predicting,
    openSignal,
    openMinutosIA,
    janelaQuenteScore,
    openExplosionIA, 
    nivelAtual,
    sugestaoMinutos,
    openLive
}) => {
    const percent = total > 0 ? ((greens / total) * 100).toFixed(1) : "0.0";

    const mainValue = prediction?.signals?.[0]
        ? Number(prediction.signals[0])
        : null;
    
    const isHot = janelaQuenteScore > 0;
    
    const minutosMainText = sugestaoMinutos && isHot ? sugestaoMinutos : `Score ${janelaQuenteScore}/3`;
    const minutosSubText = sugestaoMinutos && isHot ? 'Estrat√©gia' : 'Minutos';

    const explosionText = `N√≠vel ${nivelAtual}`;

    // AQUI EST√Å O AJUSTE PRINCIPAL:
    // Reduzimos o padding vertical dos cards de p-3 para p-2 e ajustamos o texto.
    // O p-4 do container foi mantido, mas o space-x-2 e max-w-full garantem melhor distribui√ß√£o.
    return (
        <div className="fixed bottom-0 left-0 right-0 px-2 pb-3 pt-1 flex justify-center z-20"> 
            {/* px-2 e pb-3 para margem lateral e inferior. pt-1 para um toque de espa√ßo superior. */}
            <div className="flex w-full max-w-lg space-x-2"> 
                
                {/* 1. LIVE EXCLUSIVA */}
                <button
                    onClick={openLive}
                    className="flex-1 bg-red-700/60 backdrop-blur-sm border border-red-500/50 rounded-xl p-2 flex flex-col items-center hover:bg-red-600/60 transition"
                >
                    <i data-lucide="video" className="w-5 h-5 text-white" fill="white"></i>
                    <span className="text-xs mt-0.5 font-bold text-white">LIVE VIP</span>
                    <span className="text-[10px] text-red-200">Exclusiva</span>
                </button>

                {/* 2. ASSERTIVIDADE */}
                <div className="flex-1 bg-[#111]/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-2 flex flex-col items-center">
                    <i data-lucide="check-circle" className="w-5 h-5 text-cyan-400"></i>
                    <span className="text-xs mt-0.5 font-bold">{percent}%</span>
                    <span className="text-[10px] text-gray-400">
                        {greens}G ‚Ä¢ {reds}R
                    </span>
                </div>

                {/* 3. IA DE SINAIS */}
                <button
                    onClick={openSignal}
                    className="flex-1 bg-[#111]/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-2 flex flex-col items-center hover:bg-white/10 transition"
                >
                    {predicting || !mainValue ? (
                        <i data-lucide="loader" className="w-5 h-5 text-purple-400 animate-spin"></i>
                    ) : (
                        <i data-lucide="brain" className="w-5 h-5 text-purple-400"></i>
                    )}

                    <span className={`text-xs font-bold mt-0.5 ${
                        predicting ? "text-gray-400" : getColorFromMultiplier(mainValue)
                    }`}>
                        {predicting ? "Analisando..." : `${mainValue.toFixed(2)}x`}
                    </span>

                    <span className="text-[10px] text-gray-400">Previs√£o IA</span>
                </button>

                {/* 4. IA DE MINUTOS (COM SUGEST√ÉO DE ENTRADA) */}
                <button
                    onClick={openMinutosIA}
                    className={`flex-1 backdrop-blur-sm rounded-xl p-2 flex flex-col items-center hover:bg-white/10 transition ${
                        janelaQuenteScore >= 2
                            ? 'bg-pink-600/80 border border-pink-500 shadow-xl animate-pulse-hot'
                            : 'bg-[#111]/60 border border-gray-700/50'
                    }`}
                >
                    <i data-lucide="clock-4" className={`w-5 h-5 ${isHot ? 'text-white' : 'text-yellow-500'}`}></i>
                    <span className={`text-xs font-bold mt-0.5 ${isHot ? 'text-white' : 'text-yellow-500'}`}>
                        {minutosMainText}
                    </span>
                    <span className={`text-[10px] ${isHot ? 'text-pink-200' : 'text-gray-400'}`}>
                        {minutosSubText}
                    </span>
                </button>
                
                {/* 5. EXPLOS√ÉO IA */}
                <button
                    onClick={openExplosionIA}
                    className={`flex-1 backdrop-blur-sm rounded-xl p-2 flex flex-col items-center hover:bg-white/10 transition ${
                        nivelAtual >= 3 
                            ? 'bg-orange-600/80 border border-orange-400 shadow-xl animate-pulse-hot'
                            : 'bg-[#111]/60 border border-gray-700/50'
                    }`}
                >
                    <i data-lucide="bomb" className={`w-5 h-5 ${nivelAtual >= 3 ? 'text-white' : 'text-orange-400'}`}></i>
                    <span className={`text-xs font-bold mt-0.5 ${nivelAtual >= 3 ? 'text-white' : 'text-orange-400'}`}>
                        {explosionText}
                    </span>
                    <span className="text-[10px] text-gray-400">Explos√£o IA</span>
                </button>
            </div>
        </div>
    );
};

// ============================================================
// NOVO COMPONENTE: ALERTA R√ÅPIDO FLUTUANTE (ALERTAS)
// ============================================================
const FastAlertIndicator = ({ fastAlert, signal4Rounds }) => {
    
    // Posi√ß√£o ajustada para o canto superior esquerdo (abaixo do Menu)
    const baseClasses = "fixed top-[58px] left-2 p-2 rounded-lg shadow-2xl z-[90] animate-pulse-hot";

    // 1. Prioridade M√°xima: Sinal de 4 Rodadas (Nova Regra)
    if (signal4Rounds.active) {
        const target = signal4Rounds.target;
        const count = signal4Rounds.count;
        return (
             <div 
                className={`${baseClasses} bg-green-700/80 border border-green-400`}
                style={{ backdropFilter: 'blur(4px)' }}
            >
                <span className="text-sm font-bold text-white">
                    {target} (Rodada {count} de 4)
                </span>
            </div>
        );
    }


    // 2. Segunda Prioridade: Alerta de Sequ√™ncia R√°pida
    if (fastAlert) {
        let alertColor = "bg-yellow-600/80 border-yellow-400";
        if (fastAlert.includes('Explodiu')) alertColor = "bg-pink-600/80 border-pink-400";
        if (fastAlert.includes('Detectada')) alertColor = "bg-purple-600/80 border-purple-400";
        // Novas cores baseadas na mensagem
        if (fastAlert.includes('surfar')) alertColor = "bg-purple-600/80 border-purple-400";
        if (fastAlert.includes('Mercado saturado')) alertColor = "bg-cyan-600/80 border-cyan-400";
        if (fastAlert.includes('Gatilho de Alta')) alertColor = "bg-green-600/80 border-green-400";


        return (
            <div 
                className={`${baseClasses} ${alertColor}`}
                style={{ backdropFilter: 'blur(4px)' }}
            >
                <span className="text-sm font-bold text-white">
                    {fastAlert}
                </span>
            </div>
        );
    }

    return null;
};


        
/* ============================================================
   COMPONENTE PRINCIPAL
   ============================================================ */
const App = () => {
    /* Aten√ß√£o: O ID de usu√°rio √© gerado anonimamente e persistido no localStorage. */
    const [userData, setUserData] = React.useState(
        () => JSON.parse(localStorage.getItem("userData")) || { 
            // ID Padr√£o para evitar a tela de cadastro
            telefone: "ANONIMO_" + (localStorage.getItem("anon_id") || new Date().getTime()),
            nome: "An√¥nimo",
        }
    );

    const [userConfig, setUserConfig] = React.useState(
        () => JSON.parse(localStorage.getItem("userConfig")) || {
            vip: false,
            ativo: true,
            bloqueado: false
        }
    ); 
    
    // Estado de controle para garantir que os dados de login/config foram checados
    const [isConfigLoaded, setIsConfigLoaded] = React.useState(false);


    /* -------------------------------------------
       1 ‚Äî Config Firebase (somente leitura)
       ------------------------------------------- */
    const firebaseConfig = {
        apiKey: "AIzaSyBod8YVf5pKWI98m9rRR8axokDkNMlXX-k",
        authDomain: "aviatordaniel100x.firebaseapp.com",
        projectId: "aviatordaniel100x",
        storageBucket: "aviatordaniel100x.firebasestorage.app",
        messagingSenderId: "169015417803",
        appId: "1:169015417803:web:ce4aa4f9b77d5ddb07344e"
    };

    const [db, setDb] = React.useState(null);

    /* Initialize Firebase once */
    React.useEffect(() => {
        try {
            const app = firebase.initializeApp(firebaseConfig);
            const _db = firebase.firestore(app);
            setDb(_db);
            // Salva um ID an√¥nimo no localStorage se ainda n√£o existir
            if (!localStorage.getItem("anon_id")) {
                localStorage.setItem("anon_id", new Date().getTime());
            }
        } catch (error) {
            // Se o Firebase falhar na inicializa√ß√£o, setDb pode n√£o ser chamado, 
            // mas o App tentar√° carregar o c√≥digo para evitar um travamento total.
            console.error("Erro ao inicializar Firebase:", error);
            // Podemos for√ßar o carregamento ap√≥s um timeout se o db for null
            setTimeout(() => {
                 if (!db) setIsConfigLoaded(true); 
            }, 5000);
        }
    }, []);

    /* -------------------------------------------
       2 ‚Äî Estados
       ------------------------------------------- */
    const [history, setHistory] = React.useState([]);
    const [greens, setGreens] = React.useState(0);
    const [reds, setReds] = React.useState(0);
    const [total, setTotal] = React.useState(0);
    const [prediction, setPrediction] = React.useState(null);
    const [predicting, setPredicting] = React.useState(true);
    
    // Alertas r√°pidos de sequ√™ncia
    const [fastAlert, setFastAlert] = React.useState(null); 

    // NOVO ESTADO: Sinal de 4 Rodadas
    const [signal4Rounds, setSignal4Rounds] = React.useState({ active: false, count: 0, target: null });

    // NOVO ESTADO: Oferta Last Minute
    const [showLastMinuteOffer, setShowLastMinuteOffer] = React.useState(false);
    
    // NOVO ESTADO: Persist√™ncia de Opt-Out da Oferta
    const [doNotShowOffer, setDoNotShowOffer] = React.useState(
        () => localStorage.getItem('doNotShowOffer') === 'true'
    );

    // NOVO ESTADO: Onboarding (Guia de Navega√ß√£o)
    const [showOnboarding, setShowOnboarding] = React.useState(false);
    const [hasShownOnboarding, setHasShownOnboarding] = React.useState(
        () => localStorage.getItem('hasShownOnboarding') === 'true'
    );
    
    /* Estados de Controle de Expira√ß√£o de Teste */
    const [trialStartTime, setTrialStartTime] = React.useState(null);
    const [trialExpirationTime, setTrialExpirationTime] = React.useState(null);
    const [isTrialExpired, setIsTrialExpired] = React.useState(false);


    /* Estados da IA de Minutos */
    const [minutos2x, setMinutos2x] = React.useState(0);
    const [minutos5x, setMinutos5x] = React.useState(0);
    const [minutos10x, setMinutos10x] = React.useState(0);
    const [janelaQuenteScore, setJanelaQuenteScore] = React.useState(0); 
    const [sugestaoMinutos, setSugestaoMinutos] = React.useState(null); 
    
    /* Estados da IA de 3 N√≠veis */
    const [nivelAtual, setNivelAtual] = React.useState(1);
    // CORRE√á√ÉO: Garante inicializa√ß√£o com objeto, corrigindo o problema de travamento do modal.
    const [proximaExplosao, setProximaExplosao] = React.useState({ tipo: "An√°lise Indispon√≠vel", faixa: "--", prob: "--", motivo: "--" }); 
    const [min2xExp, setMin2xExp] = React.useState(0); 
    const [min5xExp, setMin5xExp] = React.useState(0); 
    const [min10xExp, setMin10xExp] = React.useState(0); 
    const [densidadeBaixa, setDensidadeBaixa] = React.useState(0);
    const [tendencia, setTendencia] = React.useState("est√°vel");
    
    /* Estado do Rel√≥gio */
    const [currentTime, setCurrentTime] = React.useState(''); 
    
    // Primeiro nome do jogador
    const [firstName, setFirstName] = React.useState(userData.nome.split(' ')[0]);

    /* Modais */
    const [openMenu, setOpenMenu] = React.useState(false); 
    const [openHistory, setOpenHistory] = React.useState(false);
    const [openSignal, setOpenSignal] = React.useState(false);
    const [openProfile, setOpenProfile] = React.useState(false); 
    const [openMinutosIA, setOpenMinutosIA] = React.useState(false); 
    const [openMentoria, setOpenMentoria] = React.useState(false); 
    const [openRiskManagement, setOpenRiskManagement] = React.useState(false); 
    const [openExplosionIA, setOpenExplosionIA] = React.useState(false); 
    const [openLive, setOpenLive] = React.useState(false);


    /* -------------------------------------------
       3 ‚Äî L√≥gica de Onboarding (Primeiro Acesso)
       ------------------------------------------- */
    React.useEffect(() => {
        if (!hasShownOnboarding) {
            // Exibe o modal se nunca foi exibido
            setShowOnboarding(true);
        }
    }, [hasShownOnboarding]);

    const handleOnboardingClose = () => {
        setShowOnboarding(false);
        // Marca como exibido
        localStorage.setItem('hasShownOnboarding', 'true');
        setHasShownOnboarding(true);
    };


    /* -------------------------------------------
       4 ‚Äî L√≥gica do Logout/Oferta (Gatilho)
       ------------------------------------------- */
    const performLogout = () => {
        localStorage.removeItem("userData");
        localStorage.removeItem("anon_id");
        localStorage.removeItem("userConfig");
        window.location.href = window.location.pathname; 
    };

    const handleAttemptLogout = () => {
        // Fecha qualquer modal de navega√ß√£o aberto
        setOpenMenu(false);
        setOpenProfile(false);

        // Verifica o Opt-out. Se true, sai imediatamente.
        if (doNotShowOffer) {
            performLogout();
        } else {
            // Se n√£o fez opt-out, mostra a oferta
            setShowLastMinuteOffer(true);
        }
    };
    
    const handleOptOut = () => {
        localStorage.setItem('doNotShowOffer', 'true');
        setDoNotShowOffer(true);
        performLogout(); // Sai ap√≥s optar por n√£o ver
    };

    const handleRejectOffer = () => {
        setShowLastMinuteOffer(false);
        performLogout(); // Sai sem optar por n√£o ver
    };

    const handleAcceptOffer = () => {
        setShowLastMinuteOffer(false);
        // O link do WhatsApp j√° √© clicado, ent√£o apenas fechamos o modal.
    };


    /* -------------------------------------------
       5 ‚Äî L√≥gica do Rel√≥gio (Usado para atualizar o status de expira√ß√£o)
       ------------------------------------------- */
    React.useEffect(() => {
        const updateTime = () => {
            const agora = new Date();
            const h = String(agora.getHours()).padStart(2, '0');
            const m = String(agora.getMinutes()).padStart(2, '0');
            const s = String(agora.getSeconds()).padStart(2, '0');
            setCurrentTime(`${h}:${m}:${s}`);
        };
        
        updateTime(); 
        const intervalId = setInterval(updateTime, 1000);
        
        return () => clearInterval(intervalId); 
    }, []);
    
    /* -------------------------------------------
       6 ‚Äî L√≥gica de For√ßar Recria√ß√£o de √çcones Lucide
       ------------------------------------------- */
    React.useEffect(() => {
        // Chama lucide.createIcons() sempre que qualquer modal de navega√ß√£o abre
        // para garantir que os √≠cones dentro dos modais rec√©m-renderizados sejam transformados.
        if (typeof lucide !== 'undefined' && (openMenu || openHistory || openSignal || openProfile || openMinutosIA || openMentoria || openRiskManagement || openExplosionIA || openLive)) {
            lucide.createIcons();
        }
    }, [openMenu, openHistory, openSignal, openProfile, openMinutosIA, openMentoria, openRiskManagement, openExplosionIA, openLive]);
    
    /* -------------------------------------------
       7 ‚Äî EFEITO CR√çTICO: Checa a Expira√ß√£o do Teste
       ------------------------------------------- */
    React.useEffect(() => {
        // Roda a cada segundo (via mudan√ßa no `currentTime` - o rel√≥gio) ou quando a data de expira√ß√£o √© carregada
        if (trialExpirationTime) {
            const now = Date.now();
            // Define o estado isTrialExpired se o tempo atual for maior que o tempo de expira√ß√£o
            setIsTrialExpired(now > trialExpirationTime.getTime());
        } else {
            setIsTrialExpired(false);
        }
    }, [currentTime, trialExpirationTime]);


    /* -------------------------------------------
       8 ‚Äî L√≥gica da IA de 3 N√≠veis
       ------------------------------------------- */
    const analisarIA3Niveis = React.useCallback((lista) => {
        if (!lista || lista.length < 5) {
            setNivelAtual(1);
            setProximaExplosao({ tipo: "An√°lise Indispon√≠vel", faixa: "--", prob: "Baixa", motivo: "Hist√≥rico insuficiente" });
            return;
        }

        const agora = Date.now();

        // √öltimos picos (usando a estrutura da lista: mul e ts)
        const last2x = lista.find(v => Number(v.mul) >= 2);
        const last5x = lista.find(v => Number(v.mul) >= 4); 
        const last10x = lista.find(v => Number(v.mul) >= 10);

        const m2 = last2x ? Math.floor((agora - last2x.ts) / 60000) : 0;
        const m5 = last5x ? Math.floor((agora - last5x.ts) / 60000) : 0;
        const m10 = last10x ? Math.floor((agora - last10x.ts) / 60000) : 0;

        setMin2xExp(m2);
        setMin5xExp(m5);
        setMin10xExp(m10);

        // === DENSIDADE DE BAIXA ===
        const baixas = lista.filter(v => Number(v.mul) <= 1.40).length;
        setDensidadeBaixa(baixas);

        // === TEND√äNCIA ===
        const ultimas = lista.slice(0, 5).map(v => Number(v.mul));
        let tendenciaAtual = "est√°vel";

        // L√≥gica: se o √∫ltimo √© maior que o 5¬∫ anterior, h√° uma tend√™ncia de ALTA no ciclo.
        if (ultimas[0] > ultimas[4]) tendenciaAtual = "alta"; 
        if (ultimas[0] < ultimas[4]) tendenciaAtual = "queda";
        
        setTendencia(tendenciaAtual);

        // === CLASSIFICA√á√ÉO DOS N√çVEIS ===
        let nivel = 1;
        let previsao = {};

        // N√çVEL 3 ‚Äî ALTA EXPLOS√ÉO
        if (m10 >= 10 || (baixas >= 7 && m5 >= 8)) {
            nivel = 3;
            previsao = {
                tipo: "Explos√£o Alta",
                faixa: "10x a 50x",
                prob: m10 >= 10 ? "Alta" : "M√©dia",
                motivo: "√öltimo 10x distante e/ou drenagem longa"
            };
        }

        // N√çVEL 2 ‚Äî M√âDIA EXPLOS√ÉO
        else if (m5 >= 5 || baixas >= 5) {
            nivel = 2;
            previsao = {
                tipo: "Explos√£o M√©dia",
                faixa: "4x a 9x",
                prob: "M√©dia",
                motivo: "Ac√∫mulo de velas baixas e pico m√©dio atrasado"
            };
        }

        // N√çVEL 1 ‚Äî PEQUENA EXPLOS√ÉO
        else if (m2 >= 2 || tendenciaAtual === "alta") {
            nivel = 1;
            previsao = {
                tipo: "Explos√£o Pequena",
                faixa: "2x a 3x",
                prob: "M√©dia",
                motivo: "Tend√™ncia crescente ou pico atrasado"
            };
        }
        
        setNivelAtual(nivel);
        setProximaExplosao(previsao);
    }, [setMin2xExp, setMin5xExp, setMin10xExp, setDensidadeBaixa, setTendencia, setNivelAtual, setProximaExplosao]);


    /* -------------------------------------------
       9 ‚Äî L√≥gica da IA de Minutos (ATUALIZADA)
       ------------------------------------------- */
    const calcularMinutosIA = React.useCallback((lista) => {
        if (!lista || lista.length === 0) return;

        const agora = Date.now();

        // Reutiliza a lista mapeada (mul, ts)
        const last2x = lista.find(v => Number(v.mul) >= 2);
        const last5x = lista.find(v => Number(v.mul) >= 5);
        const last10x = lista.find(v => Number(v.mul) >= 10);

        const min2 = last2x ? Math.floor((agora - last2x.ts) / 60000) : 0;
        const min5 = last5x ? Math.floor((agora - last5x.ts) / 60000) : 0;
        const min10 = last10x ? Math.floor((agora - last10x.ts) / 60000) : 0;

        setMinutos2x(min2);
        setMinutos5x(min5);
        setMinutos10x(min10);
        
        let score = 0;
        let sugestao = null;

        const is2xHot = (min2 >= 3 && min2 <= 5);
        const is5xHot = (min5 >= 7 && min5 <= 10);
        const is10xHot = (min10 >= 10 && min10 <= 15);

        if (is2xHot) score++;
        if (is5xHot) score++;
        if (is10xHot) score++;
        
        // Determinar a sugest√£o de entrada (priorizando o maior multiplicador quente)
        if (score > 0) {
            if (is10xHot) {
                sugestao = "Entrar @ 10x";
            } else if (is5xHot) {
                sugestao = "Entrar @ 5x";
            } else if (is2xHot) {
                sugestao = "Entrar @ 2x";
            }
        }


        setSugestaoMinutos(sugestao); // SALVA A SUGEST√ÉO NO ESTADO
        setJanelaQuenteScore(score);
    }, [setMinutos2x, setMinutos5x, setMinutos10x, setSugestaoMinutos, setJanelaQuenteScore]);
    
    /* -------------------------------------------
       10 ‚Äî L√≥gica de Sinais R√°pidos (Regras de Sequ√™ncia)
       ------------------------------------------- */
    const analisarSinaisRapidos = React.useCallback((history) => {
        if (!history || history.length < 3) {
            setFastAlert(null);
            return;
        }

        const h = history.map(v => Number(v.mul));
        
        // Helpers
        const isBlueLow = val => val > 0 && val < 1.20; // Azul Fraco (Regras antigas)
        const isPurple = val => val >= 2.00 && val < 10.00; // Roxa (Regras antigas)
        const isPinkExplosion = val => val >= 20; // Explos√£o > 20x (Regras antigas)
        
        // NOVOS HELPERS:
        const isPurpleOrPink = val => val >= 2.00; // Qualquer Roxa ou Rosa
        const isHighPurple = val => val >= 3.00; // Acima de 3x (para as novas regras 1 e 5)
        const isLowMultiplier = val => val > 0 && val < 2.00; // Qualquer Azul (para as novas regras)

        // ==========================================================
        // === REGRAS DE ALERTA IMEDIATO (FastAlert)
        // ==========================================================

        // 4. Regra: Explodiu (Vela Rosa > 20x) - Mantida com alta prioridade
        if (h.length >= 1 && isPinkExplosion(h[0])) {
            setFastAlert("Explodiu! (Vela 20x+)");
            return;
        }

        // NOVO 5. Regra: Ap√≥s sequ√™ncia de duas roxas acima de 3x, alta identificada
        if (h.length >= 2 && isHighPurple(h[0]) && isHighPurple(h[1])) {
            setFastAlert("Alta identificada e hora de surfar! (2x > 3x)");
            return;
        }
        
        // NOVO 4. Regra: Ap√≥s sequ√™ncia de 8 velas azuis (Mensagem atualizada)
        const last8 = h.slice(0, 8);
        const is8Blue = last8.length === 8 && last8.every(isBlueLow);
        if (is8Blue) {
            setFastAlert("Mercado saturado, poss√≠vel onda de alta!");
            return;
        }
        
        // NOVO 1. Regra: Ap√≥s duas roxas acima de 3x e a pr√≥xima ser azul, gatilho de alta
        if (h.length >= 3 && isLowMultiplier(h[0]) && isHighPurple(h[1]) && isHighPurple(h[2])) {
            setFastAlert("Gatilho de Alta, poss√≠vel 2x na sequ√™ncia.");
            return;
        }

        // Antiga Regra 3: Sequ√™ncia (Azul + Roxa + Azul) -> Poss√≠vel 3x
        if (h.length >= 3) {
             // Ordem de leitura: h[2] (mais antiga) -> h[1] (meio) -> h[0] (mais nova)
            if (isBlueLow(h[2]) && isPurple(h[1]) && isBlueLow(h[0])) {
                setFastAlert("Poss√≠vel 3x nas pr√≥ximas 3 rodadas");
                return;
            }
        }

        // Antiga Regra 1: Sequ√™ncia (Roxa + Azul) -> Poss√≠vel 2x
        if (h.length >= 2) {
            if (isPurple(h[1]) && isBlueLow(h[0])) {
                setFastAlert("Poss√≠vel 2x nas 2 rodadas seguintes");
                return;
            }
        }
        
        // Se nenhuma regra for acionada, limpa o alerta r√°pido.
        setFastAlert(null);

    }, [setFastAlert]);

    /* -------------------------------------------
       11 ‚Äî L√≥gica de SINAL DE 4 RODADAS - TIPO 1 (2x a 27x)
       ------------------------------------------- */
    // Gatilho: [1-3x Azul < 1.50] seguido por [P/Pi >= 3.0x]
    const checkSignal2x27x = React.useCallback((h) => {
        if (!h || h.length < 2) return false;

        const h0 = Number(h[0].mul); // Latest (Trigger)
        const h1 = Number(h[1].mul); 
        const h2 = Number(h[2]?.mul || 0); 
        const h3 = Number(h[3]?.mul || 0); 

        const isBlueLow = val => val > 0 && val < 1.50;
        const isHighPurplePink = val => val >= 3.00; 

        if (!isHighPurplePink(h0)) return false; 

        // Check 1 to 3 preceding blue low
        if (isBlueLow(h1)) return true; // [B] [P/Pi]
        if (h.length >= 3 && isBlueLow(h1) && isBlueLow(h2)) return true; // [B] [B] [P/Pi]
        if (h.length >= 4 && isBlueLow(h1) && isBlueLow(h2) && isBlueLow(h3)) return true; // [B] [B] [B] [P/Pi]

        return false;
    }, []);


    /* -------------------------------------------
       12 ‚Äî L√≥gica de SINAL DE 4 RODADAS - TIPO 2 (2x a 6x)
       ------------------------------------------- */
    // Gatilho: [Roxa/Rosa > 10x] seguido por [Azul < 1.50x]
    const checkSignal2x6x = React.useCallback((h) => {
        if (!h || h.length < 2) return false;

        const h0 = Number(h[0].mul); // Latest (Trigger) -> Azul < 1.50x
        const h1 = Number(h[1].mul); // Previous (Gatilho) -> Roxa/Rosa > 10x

        const isBlueLow = val => val > 0 && val < 1.50;
        const isPinkHigh = val => val > 10.00; // Trigger: > 10x

        // Condition: [Vela Anterior > 10x] seguido por [Vela Atual < 1.50x]
        if (isBlueLow(h0) && isPinkHigh(h1)) return true;

        return false;
    }, []);
    
    /* -------------------------------------------
       13 ‚Äî L√≥gica de 3 Azuis (Estrat√©gia de Previs√£o)
       ------------------------------------------- */
   const check3Azuis = React.useCallback((h) => {
    if (h.length < 3) return false;

    const h0 = Number(h[0].mul);
    const h1 = Number(h[1].mul);
    const h2 = Number(h[2].mul);

    // AGORA: qualquer valor azul do Aviator (< 2.0x)
    const isBlue = val => val > 0 && val < 2.00;

    return isBlue(h0) && isBlue(h1) && isBlue(h2);
}, []);



   /* -------------------------------------------
   14 ‚Äî Firestore Listeners (CR√çTICO: Inclus√£o da L√≥gica de Expira√ß√£o)
   ------------------------------------------- */
React.useEffect(() => {
    // CR√çTICO: Se o DB n√£o estiver inicializado, n√£o tente criar listeners.
    if (!db) return () => {}; 

    const userId = userData.telefone;
    const unsubscribes = []; 

    try {
        // Listener 1: Nome, Data de In√≠cio e Expira√ß√£o
        // Mesmo que a regra de seguran√ßa do Firestore bloqueie, a checagem ser√° feita
        // e o estado `isConfigLoaded` ser√° setado.
        const unsubscribeName = db.collection("usuarios")
          .doc(userId)
          .onSnapshot((doc) => {
              // Verifica a exist√™ncia e l√™ os dados de configura√ß√£o/teste
              if (doc.exists) {
                  const d = doc.data();
                  
                  if (d.nome) {
                    const fullName = d.nome;
                    setFirstName(fullName.split(' ')[0]); 
                  } else {
                    setFirstName(userData.nome.split(' ')[0]);
                  }
                  
                  let expiration = null;
                  const start = d.data_inicio_teste && d.data_inicio_teste.toDate ? d.data_inicio_teste.toDate() : null;
                  
                  if (d.data_expiracao && d.data_expiracao.toDate) {
                      expiration = d.data_expiracao.toDate(); 
                  } else if (start) {
                      expiration = new Date(start.getTime() + 12 * 60 * 60 * 1000); 
                  }
                  
                  setTrialStartTime(start);
                  setTrialExpirationTime(expiration);
              }
              // CR√çTICO: Marca o carregamento da configura√ß√£o, mesmo que o documento n√£o exista
              // Isso permite que a tela de carregamento seja liberada.
              setIsConfigLoaded(true);

          }, (error) => {
              // Se houver erro de permiss√£o (seguran√ßa), o app deve continuar, mas sem dados do usu√°rio.
              console.error("Erro ao buscar nome/teste (Regra de Seguran√ßa?):", error);
              setIsConfigLoaded(true); 
          });
        unsubscribes.push(unsubscribeName);


        // Listener 2: Config do usu√°rio 
        const unsubscribeConfig = db.collection("usuarios")
          .doc(userId)
          .collection("apps")
          .doc("aviatorPro")
          .onSnapshot((doc) => {
              if (doc.exists) {
                  const cfg = doc.data();
                  setUserConfig(cfg);
                  localStorage.setItem("userConfig", JSON.stringify(cfg));
              }
              // CR√çTICO: Mesmo se o documento n√£o existir, a tela de bloqueio do teste ser√° checada no Listener 1.
          }, (error) => console.log("Config do usu√°rio n√£o encontrada (OK para an√¥nimo ou erro de regra de seguran√ßa)."));
        unsubscribes.push(unsubscribeConfig);

        // Listener 3: Hist√≥rico (Mapeia para mul e ts para as IAs)
        // ESSENCIAL: Tenta se conectar independentemente do status do Listener 1 (se a regra permitir leitura p√∫blica).
        const unsubscribeHistory = db.collection("historico_sinais")
          .orderBy("criado", "desc")
          .limit(300) 
          .onSnapshot((snap) => {
              
              if (snap.empty) {
                  console.warn("Firestore: Cole√ß√£o 'historico_sinais' est√° vazia.");
              }
              
              const arr = snap.docs.map((doc) => {
                  const d = doc.data();
                  const timestamp = d.criado;
                  const date = timestamp && timestamp.toDate ? timestamp.toDate() : new Date();
                  const mulValue = Number(d.valor).toFixed(2); 

                  return {
                      id: doc.id,
                      mul: mulValue, 
                      ts: date.getTime(),              
                      color: getColorFromMultiplier(mulValue),
                      time: date.toLocaleTimeString("pt-BR", {
                          hour: "2-digit",
                          minute: "2-digit",
                      })
                  };
              });
              
              // DETECTOR DE NOVA RODADA
              const currentLatestId = arr.length > 0 ? arr[0].id : null;
              const previousLatestId = history.length > 0 ? history[0].id : null;
              const isNewRound = currentLatestId !== previousLatestId;

              // --- L√≥gica de Contador e Persist√™ncia do Sinal de 4 Rodadas ---
              setSignal4Rounds(prev => {
                  
                  // Helpers locais para os novos gatilhos de BUSCAR
                  const h = arr.map(v => Number(v.mul));
                  const isPurpleOrPink = val => val >= 2.00; // Qualquer Roxa ou Rosa
                  const isLowMultiplier = val => val > 0 && val < 2.00; // Qualquer Azul

                  // 1. EXPIRE: Se ativo, a contagem chegou a 4 e uma nova rodada (a 5¬™) chegou, desativar.
                  if (prev.active && prev.count >= 4 && isNewRound) {
                      return { active: false, count: 0, target: null };
                  }
                  
                  // 2. INCREMENT: Se ativo e um novo dado real (nova rodada) chegou, incrementa.
                  if (prev.active && isNewRound) {
                      return { ...prev, count: prev.count + 1 };
                  }

                  // 3. NEW TRIGGER: Se inativo (ou rec√©m-expirado, count=0)
                  if (!prev.active || prev.count === 0) { 
                      
                      // Check TIPO 2: 2x a 6x (Existing, based on >10x then <1.50)
                      if (checkSignal2x6x(arr)) { 
                          return { active: true, count: 1, target: "BUSCAR 2.0x a 6x" };
                      }
                      
                      // Check TIPO 1: 2x a 27x (Existing, based on B B B then >3.0)
                      if (checkSignal2x27x(arr)) {
                          return { active: true, count: 1, target: "BUSCAR 2.0x a 27x" };
                      }
                      
                      // NOVO 3. Regra: Ap√≥s 1 Azul, 1 Roxa, 1 Azul -> Probabilidade de 3x nas pr√≥ximas 3 rodadas
                      if (h.length >= 3 && isLowMultiplier(h[0]) && isPurpleOrPink(h[1]) && isLowMultiplier(h[2])) {
                          return { active: true, count: 1, target: "BUSCAR 3x (3 Rodadas)" };
                      }
                      
                      // NOVO 2. Regra (Simplificado): Ap√≥s 3 Roxas/Rosas seguidas -> Buscar 2x nas pr√≥ximas 3 rodadas
                      // A l√≥gica de 'aguardar duas azuis' √© tratada pelo contador.
                      if (h.length >= 3 && isPurpleOrPink(h[0]) && isPurpleOrPink(h[1]) && isPurpleOrPink(h[2])) {
                          return { active: true, count: 1, target: "BUSCAR 2x (3 Rodadas)" };
                      }
                  }
                  
                  // 4. Default: Retorna o estado anterior (ex: ativo, mas ainda esperando a pr√≥xima rodada)
                  return prev;
              });

              setHistory(arr);
              calcularMinutosIA(arr); 
              analisarIA3Niveis(arr); 
              analisarSinaisRapidos(arr); 
          }, (error) => console.error("Erro no listener de TipMiner (Sem hist√≥rico):", error));
        unsubscribes.push(unsubscribeHistory);

        // Listener 4: Assertividade
        const unsubscribeAssertividade = db.collection("assertividade")
          .doc("dado")
          .onSnapshot((doc) => {
              if (!doc.exists) return;
              const d = doc.data();
              setGreens(d.greens || 0);
              setReds(d.reds || 0);
              setTotal(d.total || 0);
          }, (error) => console.error("Erro no listener de Assertividade (Sem G/R):", error));
        unsubscribes.push(unsubscribeAssertividade);

        // Listener 5: An√°lises IA (SINAIS FIXOS)
        const unsubscribeAnalises = db.collection("analises")
          .doc("sequencia_3_azuis")
          .collection("sinais")
          .orderBy("criado", "desc")
          .limit(1)
          .onSnapshot((snap) => {
              
              // O sinal √© ATIVO se ele existe e tem status ATIVO, conforme a regra original.
              if (!snap.empty) { 
                  const d = snap.docs[0].data();
                  
                  if (d.status === "ATIVO" && d.valores && d.valores.length > 0) {
                      setPrediction({
                          status: d.status,
                          signals: d.valores
                      });
                      setPredicting(false);
                      return; 
                  }
              }

              // Se n√£o houver snap ou o status n√£o for ATIVO: DESATIVAR
              setPrediction(null);
              setPredicting(true);

          }, (error) => console.error("Erro no listener de An√°lises IA (Sem Previs√£o):", error));
        unsubscribes.push(unsubscribeAnalises);

    } catch (e) {
        console.error("Erro geral nos Listeners Firestore:", e);
    }
    
    // FUN√á√ÉO DE LIMPEZA (CLEANUP) - ESSENCIAL PARA EVITAR BUGS DE RE-SUBSCRIPTION
    return () => {
        unsubscribes.forEach(unsub => unsub());
    };

}, [
    db, 
    userData, 
    check3Azuis, 
    calcularMinutosIA, 
    analisarIA3Niveis, 
    analisarSinaisRapidos, 
    checkSignal2x27x, 
    checkSignal2x6x
]);

// üö´ Usu√°rio Expirado no Teste (NOVA CHECAGEM CR√çTICA)
if (isTrialExpired && isConfigLoaded) { // S√≥ checa a expira√ß√£o ap√≥s o Listener 1 carregar
    // Calcula o tempo desde a expira√ß√£o (apenas para exibi√ß√£o)
    const timeSinceExpiration = trialExpirationTime
        ? new Date(Date.now() - trialExpirationTime.getTime()) 
        : null;
        
    const expirationTimeStr = trialExpirationTime 
        ? trialExpirationTime.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' })
        : 'Indispon√≠vel';
        
    return (
        <div className="fixed inset-0 bg-[#111] flex justify-center items-center p-6 text-center">
            <div className="max-w-md bg-[#1a1a1a] p-8 rounded-xl shadow-2xl border-4 border-red-500/70">
                <i data-lucide="clock-off" className="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                <h1 className="text-2xl font-extrabold text-red-400 mb-2">ACESSO EXPIRADO</h1>
                <p className="text-white mb-4">
                    Seu per√≠odo de teste gratuito de 12 horas expirou. 
                    O acesso foi bloqueado automaticamente.
                </p>
                <p className="text-sm text-gray-400 mb-4">
                    (In√≠cio do teste: {trialStartTime ? trialStartTime.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' }) : 'N/A'} - Expira√ß√£o: {expirationTimeStr})
                </p>
                
                <a 
                    href={`https://wa.me/5551989378751?text=Ol%C3%A1%2C%20meu%20acesso%20expirou%20e%20quero%20ativar%20minha%20conta%20VIP!%20(ID%3A%20${userData.telefone})`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="w-full mt-4 inline-block bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-xl transition shadow-lg"
                >
                    <i data-lucide="zap" className="w-5 h-5 mr-1 inline-block"></i>
                    Ativar Conta VIP Agora!
                </a>
                
            </div>
        </div>
    );
}

// üö´ Usu√°rio bloqueado
if (isConfigLoaded && userConfig?.bloqueado === true) { // S√≥ checa ap√≥s o Listener 1 carregar
    return (
        <div className="text-center text-red-500 p-6 text-xl">
            Seu acesso foi bloqueado.  
            Entre em contato com o suporte.
        </div>
    );
}

// üö´ Usu√°rio inativo
if (isConfigLoaded && userConfig?.ativo === false) { // S√≥ checa ap√≥s o Listener 1 carregar
    return (
        <div className="text-center text-yellow-400 p-6 text-xl">
            Seu acesso est√° desativado temporariamente.
        </div>
    );
}

// Exibe a tela de carregamento at√© que o DB seja inicializado e a configura√ß√£o (Listener 1) carregue.
if (!db || !isConfigLoaded) {
     return (
        /* CORRIGIDO: O fundo da tela de carregamento foi alterado para ser claramente vis√≠vel */
        <div className="fixed inset-0 bg-[#1a1a1a] flex justify-center items-center">
            <div className="text-center text-green-400">
                <i data-lucide="loader-circle" className="w-10 h-10 animate-spin mb-4 mx-auto"></i>
                <p className="text-lg">Carregando Plataforma PRO...</p>
                <p className="text-sm text-gray-400 mt-2">Verificando regras de acesso e hist√≥rico...</p>
            </div>
        </div>
    );
}


    /* -------------------------------------------
       15 ‚Äî Renderiza√ß√£o
       ------------------------------------------- */
    return (
        <div className="min-h-screen flex flex-col bg-[#0a0a0a]">
            
            <FastAlertIndicator 
                fastAlert={fastAlert} 
                signal4Rounds={signal4Rounds}
            /> {/* INDICADOR R√ÅPIDO/ALERTAS */}

            {/* NAVBAR */}
            <NavigationBar
                onMenu={() => setOpenMenu(true)} 
                onHistory={() => setOpenHistory(true)} 
                onMentoria={() => setOpenMentoria(true)} 
                currentTime={currentTime} 
                firstName={firstName}
            />

            {/* √ÅREA PRINCIPAL ‚Äî JOGO */}
            <div className="flex-1 overflow-hidden">
                <iframe
                    src="https://rn72q.com/subscribeReward?pid=575973404"
                    allow="fullscreen"
                    title="Jogo Integrado"
                ></iframe>
            </div>

            {/* RODAP√â (5 BOT√ïES) */}
            <FooterBar
                greens={greens}
                reds={reds}
                total={total}
                prediction={prediction}
                predicting={predicting}
                openSignal={() => setOpenSignal(true)}
                openMinutosIA={() => setOpenMinutosIA(true)} 
                janelaQuenteScore={janelaQuenteScore}
                openExplosionIA={() => setOpenExplosionIA(true)} 
                nivelAtual={nivelAtual} 
                sugestaoMinutos={sugestaoMinutos}
                openLive={() => setOpenLive(true)}
            />

            {/* MODAIS */}
            <MenuModal
                open={openMenu}
                onClose={() => setOpenMenu(false)}
                onHistory={() => setOpenHistory(true)}
                onProfile={() => setOpenProfile(true)}
                onRiskManagement={() => setOpenRiskManagement(true)} 
                onAttemptLogout={handleAttemptLogout} /* PASSANDO A FUN√á√ÉO DE SA√çDA */
            />

            <RiskManagementModal
                open={openRiskManagement}
                onClose={() => setOpenRiskManagement(false)}
            />

            <MentoriaModal
                open={openMentoria}
                onClose={() => setOpenMentoria(false)}
            />
            
            {/* MODAL DE ONBOARDING - S√ì APARECE NA PRIMEIRA VEZ */}
            <OnboardingImageModal
                open={showOnboarding}
                onClose={handleOnboardingClose}
                onOptOut={handleOnboardingClose} // Opt-out faz o mesmo que fechar neste contexto
            />
            
            {/* NOVO MODAL: OFERTA LAST MINUTE (APARECE NO LOGOUT) */}
            <LastMinuteOfferModal
                open={showLastMinuteOffer}
                onAccept={handleAcceptOffer}
                onReject={handleRejectOffer}
                onOptOut={handleOptOut}
            />

            <HistoryModal
                open={openHistory}
                onClose={() => setOpenHistory(false)}
                history={history}
            />

            <SignalModal
                open={openSignal}
                onClose={() => setOpenSignal(false)}
                prediction={prediction}
            />
            
            <MinutosIAModal
                open={openMinutosIA}
                onClose={() => setOpenMinutosIA(false)}
                minutos2x={minutos2x}
                minutos5x={minutos5x}
                minutos10x={minutos10x}
                janelaQuenteScore={janelaQuenteScore}
                sugestaoMinutos={sugestaoMinutos}
            />
            
            <ExplosionPanelModal
                open={openExplosionIA}
                onClose={() => setOpenExplosionIA(false)}
                nivelAtual={nivelAtual}
                proximaExplosao={proximaExplosao}
                min2xExp={min2xExp}
                min5xExp={min5xExp}
                min10xExp={min10xExp}
                densidadeBaixa={densidadeBaixa}
                tendencia={tendencia}
            />

            <ProfileModal
                open={openProfile}
                onClose={() => setOpenProfile(false)}
                userData={userData}
                userConfig={userConfig}
                onAttemptLogout={handleAttemptLogout} /* PASSANDO A FUN√á√ÉO DE SA√çDA */
            />
            
            <LiveStreamModal
                open={openLive}
                onClose={() => setOpenLive(false)}
                isVip={userConfig?.vip}
            />
        </div>
    );
};

/* ============================================================
   RENDER FINAL
   ============================================================ */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

/* Inicializa √≠cones Lucide (Fallback, pois a fun√ß√£o √© chamada via useEffect nos Modais) */
setTimeout(() => {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}, 300);

</script> 
</body>
</html>
